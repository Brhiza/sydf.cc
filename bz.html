<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字</title>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="static/favicon.png" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 20px auto;
        }
        h1 {
            color: #1a237e; /* 深蓝色标题 */
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #283593; /* 稍浅的蓝色副标题 */
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e8eaf6; /* 淡蓝色下划线 */
            padding-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600; /* 稍粗的字体 */
            color: #3949ab; /* 标签颜色 */
        }
        input[type="number"],
        select {
            width: 100%; /* 改为100%配合box-sizing */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #c5cae9; /* 边框颜色 */
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input[type="number"]:focus,
        select:focus {
            border-color: #3f51b5; /* 焦点时边框颜色 */
            outline: none;
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }
        .ai-question-button {
            background-color: #3f51b5; /* 主题蓝色 */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: block; /* 让按钮独占一行并居中 */
            width: 100%;
            max-width: 200px; /* 按钮最大宽度 */
            margin: 20px auto 0; /* 上边距，并水平居中 */
        }
        .ai-question-button:hover {
            background-color: #303f9f; /* 悬停时深一点的蓝色 */
        }

        .unified-button {
            background-color: white;
            color: #3f51b5;
            border: 1px solid #3f51b5;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 20px auto 0;
        }
        .unified-button.selected {
            background-color: #3f51b5;
            color: white;
            border: none;
        }
        .unified-button:hover {
            background-color: #303f9f;
        }
    
        .hidden {
            display: none;
        }
        
        .ai-question-button.selected {
            background-color: #3f51b5;
            color: white;
            border: 1px solid #3f51b5;
        }
        .ai-question-button:not(.selected):hover {
            background-color: #e8eaf6;
        }

        #result,
        #result2 {
            margin-top: 30px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            white-space: normal;
            word-wrap: break-word;
        }

        #result h3,
        #result2 h3 {
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #333;
        }

        #result p,
        #result2 p {
            margin-bottom: 5px;
            color: #333;
        }

        #result strong,
        #result2 strong {
            color: inherit;
            font-weight: bold;
        }

        #result ul,
        #result2 ul {
            list-style-type: disc;
            padding-left: 30px;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        #result li,
        #result2 li {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .gender-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .gender-button {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #c5cae9;
            border-radius: 6px;
            background-color: #fff;
            color: #3f51b5;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .gender-button.selected {
            background-color: #3f51b5;
            color: #fff;
            border-color: #3f51b5;
        }

        .gender-button:not(.selected):hover {
            background-color: #e8eaf6;
        }
        .date-inputs-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .date-input-group {
            flex: 1;
            min-width: 0;
        }

        .date-input-group label {
            margin-bottom: 8px;
        }

        .date-input-group input[type="number"], .date-input-group select {
            width: 100%;
            margin-bottom: 0;
        }
        #aiQuestionOptions, #combinedQuestionOptions {
                display: none;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 10px;
                padding: 20px 0;
                margin-top: 20px;
                border-top: 1px solid #eee;
            }
            
        #aiQuestionOptions .unified-button, #combinedQuestionOptions .unified-button {
            display: inline-block;
            min-width: fit-content;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>八字排盘</h1>
        
        <div class="date-inputs-row">
            <div class="date-input-group">
                <label for="year">年</label>
                <input type="number" id="year" name="year" placeholder="2000" required>
            </div>
            <div class="date-input-group">
                <label for="month">月</label>
                <input type="number" id="month" name="month" min="1" max="12" placeholder="1-12" required>
            </div>
            <div class="date-input-group">
                <label for="day">日</label>
                <input type="number" id="day" name="day" min="1" max="31" placeholder="1-31" required>
            </div>
        </div>

        <div>
            <label for="hour">时辰:</label>
            <select id="hour" name="hour" required>
                <option value="0"selected>早子时 (00:00-01:00)</option>
                <option value="1">丑时 (01:00-03:00)</option>
                <option value="2">寅时 (03:00-05:00)</option>
                <option value="3">卯时 (05:00-07:00)</option>
                <option value="4">辰时 (07:00-09:00)</option>
                <option value="5">巳时 (09:00-11:00)</option>
                <option value="6">午时 (11:00-13:00)</option>
                <option value="7">未时 (13:00-15:00)</option>
                <option value="8">申时 (15:00-17:00)</option>
                <option value="9">酉时 (17:00-19:00)</option>
                <option value="10">戌时 (19:00-21:00)</option>
                <option value="11">亥时 (21:00-23:00)</option>
                <option value="12">晚子时 (23:00-24:00)</option>
            </select>
        </div>
        <div>
            <label>性别:</label>
            <div class="gender-buttons">
                <button type="button" class="gender-button" id="genderMale">男</button>
                <button type="button" class="gender-button" id="genderFemale">女</button>
            </div>
        </div>

        <div>
            <input type="checkbox" id="enableSecondPerson" onchange="toggleSecondPersonInputs()">
            <label for="enableSecondPerson" style="display: inline; margin-left: 5px;">合盘</label>
        </div>

        <div id="secondPersonInputs" style="display:none; margin-top: 20px; padding-top:20px; border-top: 1px dashed #ccc;">
            <h2>第二人信息</h2>
            <div class="date-inputs-row">
                <div class="date-input-group">
                    <label for="year2">年</label>
                    <input type="number" id="year2" name="year2" placeholder="2000">
                </div>
                <div class="date-input-group">
                    <label for="month2">月</label>
                    <input type="number" id="month2" name="month2" min="1" max="12" placeholder="1-12">
                </div>
                <div class="date-input-group">
                    <label for="day2">日</label>
                    <input type="number" id="day2" name="day2" min="1" max="31" placeholder="1-31">
                </div>
            </div>
            <div>
                <label for="hour2">时辰:</label>
                <select id="hour2" name="hour2">
                    <option value="0"selected>早子时 (00:00-01:00)</option>
                    <option value="1">丑时 (01:00-03:00)</option>
                    <option value="2">寅时 (03:00-05:00)</option>
                    <option value="3">卯时 (05:00-07:00)</option>
                    <option value="4">辰时 (07:00-09:00)</option>
                    <option value="5">巳时 (09:00-11:00)</option>
                    <option value="6">午时 (11:00-13:00)</option>
                    <option value="7">未时 (13:00-15:00)</option>
                    <option value="8">申时 (15:00-17:00)</option>
                    <option value="9">酉时 (17:00-19:00)</option>
                    <option value="10">戌时 (19:00-21:00)</option>
                    <option value="11">亥时 (21:00-23:00)</option>
                    <option value="12">晚子时 (23:00-24:00)</option>
                </select>
            </div>
            <div>
                <label>性别:</label>
                <div class="gender-buttons">
                    <button type="button" class="gender-button" id="genderMale2">男</button>
                    <button type="button" class="gender-button" id="genderFemale2">女</button>
                </div>
            </div>
        </div>

        <button class="ai-question-button" onclick="generateAstrolabe()">开始排盘</button>
        <h2>排盘结果:</h2>
        <div id="result" style="display:none;"></div>
        <div id="result2" style="margin-top: 20px; display:none;"></div>
        
        <div id="aiQuestionContainer" style="display:none;">
            <div id="aiQuestionOptions">
                <button class="unified-button" data-default-text="请进行全面分析八字格局和五行喜忌，然后分析心性性格、事业、财运、感情、身体健康以及注意事项。" onclick="selectOption(this, 'single')">综合</button>
                <button class="unified-button" data-default-text="请分析我在当前大运的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">大运</button>
                <button class="unified-button" data-default-text="请分析我在今年的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">流年</button>
                <button class="unified-button" data-default-text="请分析我在今年每一个月的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">年运</button>
                <button class="unified-button" data-default-text="请分析我今、明、后三年的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">三年</button>
                <button class="unified-button" data-default-text="请分析我的事业和财运，并给出总结和建议以及注意事项" onclick="selectOption(this, 'single')">事业财运</button>
                <button class="unified-button" data-default-text="请分析我的感情和婚姻状况，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">感情婚姻</button>
                <button class="unified-button" data-default-text="请分析我的健康状况，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">健康</button>
                <button class="unified-button" onclick="showCustomInput('single'); selectOption(this, 'single');">自定义</button>
            </div>
            <div id="customQuestionContainer" style="width: 100%; margin-top: 10px;">
                <input type="text" id="customQuestion" placeholder="请输入您的问题" style="display: none; width: 100%; padding: 12px; border: 1px solid #c5cae9; border-radius: 6px; box-sizing: border-box; font-size: 16px;">
            </div>
            <button class="ai-question-button" onclick="askAI()" style="margin-top: 10px;">向 AI 提问</button>
        </div>

        <!-- 合盘分析容器 -->
        <div id="combinedAnalysisContainer" style="display:none;">
            <div id="combinedQuestionOptions">
                <button class="unified-button" data-default-text="请分析两个人命盘合不合，双方是否互补，双方性格怎么样，在一起几率高不高，有利和不利的婚姻因素，需要注意的年份，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'combined');">合婚</button>
                <button class="unified-button" data-default-text="请分析我们在事业合作方面的匹配度，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'combined');">合作</button>
                <button class="unified-button" onclick="showCustomInput('combined'); selectOption(this, 'combined');">自定义</button>
            </div>
            <div id="customCombinedQuestionContainer" style="width: 100%; margin-top: 10px;">
                <input type="text" id="customCombinedQuestion" placeholder="请输入您的问题" style="display: none; width: 100%; padding: 12px; border: 1px solid #c5cae9; border-radius: 6px; box-sizing: border-box; font-size: 16px;">
            </div>
            <button class="ai-question-button" onclick="askAIForCompatibility()" style="margin-top: 10px;">AI 合盘分析</button>
        </div>

    </div>

    <script src="ai.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro@latest/dist/iztro.min.js"></script>
    <script src="paipan.js"></script>
    <script>
        // 缓存 DOM 元素
        const dom = {
            year1: document.getElementById('year'),
            month1: document.getElementById('month'),
            day1: document.getElementById('day'),
            hour1: document.getElementById('hour'),
            genderMale1: document.getElementById('genderMale'),
            genderFemale1: document.getElementById('genderFemale'),
            enableSecondPerson: document.getElementById('enableSecondPerson'),
            secondPersonInputs: document.getElementById('secondPersonInputs'),
            year2: document.getElementById('year2'),
            month2: document.getElementById('month2'),
            day2: document.getElementById('day2'),
            hour2: document.getElementById('hour2'),
            genderMale2: document.getElementById('genderMale2'),
            genderFemale2: document.getElementById('genderFemale2'),
            result1Div: document.getElementById('result'),
            result2Div: document.getElementById('result2'),
            aiQuestionContainer: document.getElementById('aiQuestionContainer'),
            aiQuestionOptions: document.getElementById('aiQuestionOptions'),
            customQuestion: document.getElementById('customQuestion'),
            combinedAnalysisContainer: document.getElementById('combinedAnalysisContainer'),
            combinedQuestionOptions: document.getElementById('combinedQuestionOptions'),
            customCombinedQuestion: document.getElementById('customCombinedQuestion'),
            mainContainer: document.querySelector('.container')
        };

        let selectedGender = null;
        let selectedGender2 = null;

        // 性别选择事件监听
        dom.genderMale1.addEventListener('click', () => {
            dom.genderMale1.classList.add('selected');
            dom.genderFemale1.classList.remove('selected');
            selectedGender = '男';
        });

        dom.genderFemale1.addEventListener('click', () => {
            dom.genderFemale1.classList.add('selected');
            dom.genderMale1.classList.remove('selected');
            selectedGender = '女';
        });

        dom.genderMale2.addEventListener('click', () => {
            dom.genderMale2.classList.add('selected');
            dom.genderFemale2.classList.remove('selected');
            selectedGender2 = '男';
        });

        dom.genderFemale2.addEventListener('click', () => {
            dom.genderFemale2.classList.add('selected');
            dom.genderMale2.classList.remove('selected');
            selectedGender2 = '女';
        });

        function generateAstrolabeForPerson(personNumber, year, month, day, timeIndex, gender, resultDiv) {
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';

            if (isNaN(year) || isNaN(month) || isNaN(day) || timeIndex === null) {
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人：请输入所有必填的出生信息！</p>`;
                resultDiv.style.display = 'block';
                return null;
            }

            if (!gender) {
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人：性别都不告诉我？</p>`;
                resultDiv.style.display = 'block';
                return null;
            }

            const solarDate = `${year}-${month}-${day}`;

            try {
                const astrolabe = iztro.astro.bySolar(solarDate, timeIndex, gender, true, 'zh-CN');
                let htmlResult = `<h3>${personNumber === 1 ? '基本信息：' : `第${personNumber}人 - 基本信息：`}</h3>`;
                htmlResult += `<p><strong>阳历：</strong>${astrolabe.solarDate}</p>`;
                htmlResult += `<p><strong>农历：</strong>${astrolabe.lunarDate}</p>`;
                htmlResult += `<p><strong>干支：</strong>${astrolabe.chineseDate}</p>`;
                htmlResult += `<p><strong>性别：</strong>${astrolabe.gender}</p>`;
                htmlResult += `<p><strong>时辰：</strong>${astrolabe.time}</p>`;

                // 推算大运
                try {
                    const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 23];
                    const hourForPaipan = hourMap[timeIndex];
                    const baziResult = p.fatemaps(gender === '男' ? 0 : 1, year, month, day, hourForPaipan, 0, 0);

                    if (baziResult && baziResult.dy) {
                        htmlResult += `<h3>大运：</h3>`;
                        htmlResult += `<p><strong>起运：</strong>${baziResult.qyy_desc}</p>`;
                        htmlResult += `<p>${baziResult.qyy_desc2}</p>`;
                        htmlResult += `<ul>`;
                        baziResult.dy.forEach((yun, index) => {
                            htmlResult += `<li><strong>${yun.syear}年 (${yun.zqage}岁):</strong> ${yun.zfma}${yun.zfmb} (${yun.nzsc})</li>`;
                        });
                        htmlResult += `</ul>`;
                    }
                } catch (e) {
                    console.error('大运推算错误:', e);
                    htmlResult += `<p style="color: red;">大运推算失败。</p>`;
                }

                resultDiv.innerHTML = htmlResult;
                resultDiv.style.display = 'block';
                return astrolabe;
            } catch (error) {
                console.error(`第${personNumber}人排盘错误:`, error);
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人排盘失败，请检查输入或查看控制台错误信息。</p><p>${error.message}</p>`;
                resultDiv.style.display = 'block';
                return null;
            }
        }

        function generateAstrolabe() {
            const year1Val = dom.year1.value;
            const month1Val = dom.month1.value;
            const day1Val = dom.day1.value;
            const hour1Val = dom.hour1.value;
            
            let astrolabe1 = null;
            let astrolabe2 = null;
            let allSuccess = true;
            
            if (year1Val !== '' && month1Val !== '' && day1Val !== '' && hour1Val !== '' && selectedGender) {
                const year1 = parseInt(year1Val);
                const month1 = parseInt(month1Val);
                const day1 = parseInt(day1Val);
                const timeIndex1 = parseInt(hour1Val);
                astrolabe1 = generateAstrolabeForPerson(1, year1, month1, day1, timeIndex1, selectedGender, dom.result1Div);
                if (!astrolabe1) allSuccess = false;
            } else {
                dom.result1Div.innerHTML = '<p style="color: red;">请输入第一个人的完整出生信息！</p>';
                dom.result1Div.style.display = 'block';
                allSuccess = false;
            }

            if (dom.enableSecondPerson.checked) {
                const year2Val = dom.year2.value;
                const month2Val = dom.month2.value;
                const day2Val = dom.day2.value;
                const hour2Val = dom.hour2.value;

                if (year2Val !== '' && month2Val !== '' && day2Val !== '' && hour2Val !== '' && selectedGender2) {
                    const year2 = parseInt(year2Val);
                    const month2 = parseInt(month2Val);
                    const day2 = parseInt(day2Val);
                    const timeIndex2 = parseInt(hour2Val);
                    astrolabe2 = generateAstrolabeForPerson(2, year2, month2, day2, timeIndex2, selectedGender2, dom.result2Div);
                    if (!astrolabe2) allSuccess = false;
                } else {
                    dom.result2Div.innerHTML = '<p style="color: red;">请输入第二个人的完整出生信息！</p>';
                    dom.result2Div.style.display = 'block';
                    allSuccess = false;
                }
            } else {
                dom.result2Div.innerHTML = '';
                dom.result2Div.style.display = 'none';
            }

            dom.aiQuestionContainer.style.display = 'none';
            dom.combinedAnalysisContainer.style.display = 'none';

            if (allSuccess) {
                if (dom.enableSecondPerson.checked) {
                    dom.combinedAnalysisContainer.style.display = 'block';
                    dom.combinedQuestionOptions.style.display = 'flex';
                    setDefaultOption('combined');
                } else {
                    dom.aiQuestionContainer.style.display = 'block';
                    dom.aiQuestionOptions.style.display = 'flex';
                    setDefaultOption('single');
                }
            }
        }

        function setDefaultOption(type = 'single') {
            const containerId = type === 'combined' ? 'combinedQuestionOptions' : 'aiQuestionOptions';
            const defaultButton = document.querySelector(`#${containerId} button:first-child`);
            if(defaultButton) defaultButton.click();
        }

        function toggleSecondPersonInputs() {
            const isChecked = dom.enableSecondPerson.checked;
            dom.secondPersonInputs.style.display = isChecked ? 'block' : 'none';
            if (!isChecked) {
                dom.result2Div.innerHTML = '';
                dom.result2Div.style.display = 'none';
                dom.combinedAnalysisContainer.style.display = 'none';
            }
        }

        function showCustomInput(type = 'single') {
            const customInput = type === 'combined' ? dom.customCombinedQuestion : dom.customQuestion;
            customInput.style.display = 'block';
            customInput.focus();
        }

        function selectOption(button, type = 'single') {
            const optionsContainer = type === 'combined' ? dom.combinedQuestionOptions : dom.aiQuestionOptions;
            const customInput = type === 'combined' ? dom.customCombinedQuestion : dom.customQuestion;
            
            optionsContainer.querySelectorAll('.unified-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            if (button.textContent.trim() !== '自定义') {
                customInput.style.display = 'none';
            }
        }

        async function handleAIQuery(prompt) {
            let aiResponseDiv = document.getElementById('aiResponse');
            if (!aiResponseDiv) {
                aiResponseDiv = document.createElement('div');
                aiResponseDiv.id = 'aiResponse';
                aiResponseDiv.style.marginTop = '20px';
                aiResponseDiv.style.padding = '15px';
                aiResponseDiv.style.borderRadius = '8px';
                aiResponseDiv.style.backgroundColor = '#f8f9fa';
                aiResponseDiv.style.whiteSpace = 'pre-wrap';
                aiResponseDiv.style.wordWrap = 'break-word';
                aiResponseDiv.style.overflowY = 'auto'; 
                dom.mainContainer.appendChild(aiResponseDiv);
            }
            
            aiResponseDiv.style.display = 'block';
            aiResponseDiv.innerHTML = '';

            try {
                const aiResponse = await queryAI(prompt);
                for await (const content of aiResponse.streamResponse()) {
                    aiResponseDiv.innerHTML += content;
                    aiResponseDiv.scrollTop = aiResponseDiv.scrollHeight;
                }
            } catch (error) {
                console.error('请求失败:', error);
                aiResponseDiv.innerHTML = "哈哈，AI开小差了";
            }
        }

        function getLunarCalendarInfoForYear(year) {
            let info = `\n\n${year}年 农历月历参考：\n`;
            const [mc, sjd] = p.GetZQandSMandLunarMonthCode(year);
            
            for (let i = 0; i < sjd.length - 1; i++) {
                const monthCode = mc[i];
                if (monthCode < 2) continue;

                const monthName = p.dxy[Math.floor(monthCode - 2) % 12];
                const isLeap = monthCode !== Math.floor(monthCode);
                const startDate = p.Jtime(sjd[i]);
                const endDate = p.Jtime(sjd[i+1] - 1);

                const gzYear = p.GetGZ(year, 1, 1, 0, 0, 0)[2].ty;
                const monthGZIndex = (gzYear % 5) * 12 + 2 + Math.floor(monthCode - 2);
                const monthGZ = p.gz[(monthGZIndex + 60) % 60];

                info += `农历${isLeap ? '闰' : ''}${monthName}(${monthGZ}月): 西历${startDate[0]}年${startDate[1]}月${startDate[2]}日 - ${endDate[0]}年${endDate[1]}月${endDate[2]}日\n`;
            }
            return info;
        }

        function askAI() {
            const selectedOption = dom.aiQuestionOptions.querySelector('.unified-button.selected');
            const isCustom = selectedOption.textContent.trim() === '自定义';
            const questionText = isCustom ? dom.customQuestion.value : selectedOption.dataset.defaultText;
            let prompt = `你是一个八字大师，现在是${new Date().toLocaleString()}，以下是排盘结果：\n${dom.result1Div.innerHTML}\n问题: ${questionText}\n请尽量详细的说明`;

            if (selectedOption.dataset.defaultText && selectedOption.dataset.defaultText.includes("今年每一个月的运势")) {
                const year = new Date().getFullYear();
                prompt += getLunarCalendarInfoForYear(year);
            }
            
            handleAIQuery(prompt);
        }

        function askAIForCompatibility() {
            const selectedOption = dom.combinedQuestionOptions.querySelector('.unified-button.selected');
            const isCustom = selectedOption.textContent.trim() === '自定义';
            const questionText = isCustom ? dom.customCombinedQuestion.value : selectedOption.dataset.defaultText;
            const prompt = `你是一个八字大师，现在是${new Date().toLocaleString()}，以下是排盘结果：\n第一人排盘结果:\n${dom.result1Div.innerHTML}\n\n第二人排盘结果:\n${dom.result2Div.innerHTML}\n问题：${questionText}\n请尽量详细的说明`;
            handleAIQuery(prompt);
        }

        function displayLunarCalendar() {
            const year = new Date().getFullYear();
            const lunarCalendarDiv = document.getElementById('lunarCalendar');
            lunarCalendarDiv.innerHTML = `<h3>${year}年 农历月历</h3>`;
            lunarCalendarDiv.style.display = 'block';

            let html = '<ul>';
            const [mc, sjd] = p.GetZQandSMandLunarMonthCode(year);
            
            let lastSolarDate = null;

            for (let i = 0; i < sjd.length - 1; i++) {
                const monthCode = mc[i];
                if (monthCode < 2) continue; // Skip previous year's months

                const monthName = p.dxy[Math.floor(monthCode - 2) % 12];
                const isLeap = monthCode !== Math.floor(monthCode);
                const startDate = p.Jtime(sjd[i]);
                const endDate = p.Jtime(sjd[i+1] - 1);

                const gzYear = p.GetGZ(year, 1, 1, 0, 0, 0)[2].ty;
                const monthGZIndex = (gzYear % 5) * 12 + 2 + Math.floor(monthCode - 2);
                const monthGZ = p.gz[(monthGZIndex + 60) % 60];

                html += `<li><strong>农历${isLeap ? '闰' : ''}${monthName}(${monthGZ}月)</strong><br>`;
                html += `西历${startDate[0]}年${startDate[1]}月${startDate[2]}日 &mdash;&mdash; ${endDate[0]}年${endDate[1]}月${endDate[2]}日</li>`;
            }

            html += '</ul>';
            lunarCalendarDiv.innerHTML += html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setDefaultOption('single');
        });
    </script>
</body>
</html>