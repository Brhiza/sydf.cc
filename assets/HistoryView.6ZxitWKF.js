import{D as e}from"./DivinationResult.BUBwWTxs.js";import{h as s,c as t,e as a,E as i,g as o,_ as n}from"./index.C-qxr2xH.js";import{r as l,x as r,d as c,p as d,o as u,a as y,c as p,u as v,b as h,t as f,g as m,q as R,F as g,l as k,n as I,e as H}from"./vendor.BOsypETj.js";import"./markdown.CaxBdgEJ.js";import"./DailyResult.BoPrrIn1.js";import"./utils.CwRxlNlL.js";const b={class:"page-container"},D={key:0,class:"content-card"},A={class:"detail-header"},w={class:"header-left"},j={class:"section-title"},x={class:"detail-date"},C={class:"header-actions"},E={class:"detail-content"},S={class:"detail-question"},_={class:"content-text"},q={class:"detail-result"},N={key:0,class:"detail-conversation"},O={class:"conversation-history"},T={class:"message-content"},B={class:"form-actions"},$={key:1,class:"content-card"},z={class:"history-content"},J={key:0,class:"empty-message"},L={key:1,class:"history-list"},P=["onClick"],U={class:"item-header"},Y={class:"item-type"},F={class:"item-date"},V={class:"item-question"},G={key:0,class:"form-actions"},K=n(c({__name:"HistoryView",props:{selectedRecordId:{type:String,default:null},showDetail:{type:Boolean,default:!1}},setup(n){const c=n,{historyRecords:K,selectedRecord:M,loadHistory:Q,viewHistoryDetail:W,clearAllHistory:X,deleteHistoryRecord:Z,goBack:ee}=function(e){const t=r(),a=l([]),i=l(null);function o(){t.push("/history")}return{historyRecords:a,selectedRecord:i,loadHistory:function(){if(a.value=s.getRecords(),e){const s=a.value.find(s=>s.id===e);s?i.value=s:t.push("/history")}},viewHistoryDetail:function(e){t.push(`/divination/${e.type}?historyId=${e.id}`)},clearAllHistory:function(){confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")&&(s.clearRecords(),a.value=[],i.value=null)},deleteHistoryRecord:function(e){confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")&&(s.deleteRecord(e),o())},goBack:o}}(c.selectedRecordId),{getAIError:se,handleRetryAI:te}=function(){const e=l(!1);return{isRetryingAI:e,getAIError:function(e){return e.result.aiResponse?["æŠ±æ­‰","æš‚æ—¶ä¸å¯ç”¨","è¯·ç¨åé‡è¯•","å‡ºå°å·®","è¯·æ±‚è¿‡äºé¢‘ç¹","æœåŠ¡å™¨æš‚æ—¶ç¹å¿™"].some(s=>e.result.aiResponse?.includes(s))?e.result.aiResponse:null:"AIè§£è¯»æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"},handleRetryAI:async function(a){if(!e.value){e.value=!0;try{const e=JSON.parse(JSON.stringify(a.result.data)),i=await t.generateAIResponse(a.type,a.question,e,void 0,void 0,void 0);if(!i)throw new Error("AIæœåŠ¡è¿”å›ç©ºå“åº”");a.result.aiResponse=i,s.updateRecord(a.id,a)}catch(i){const e=i instanceof Error?i.message:"é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";a.result.aiResponse=e,s.updateRecord(a.id,a)}finally{e.value=!1}}}}}();function ae(e){return new Date(e).toLocaleDateString("zh-CN")}function ie(e){const s=o(e);return s?s.title:"æœªçŸ¥å åœ"}return d(()=>c.selectedRecordId,e=>{if(e){const s=K.value.find(s=>s.id===e);s&&(M.value=s)}else M.value=null}),u(()=>{Q(),a.on(i.HISTORY_UPDATED,Q)}),y(()=>{a.off(i.HISTORY_UPDATED,Q)}),(s,t)=>{return H(),p("div",b,[n.showDetail&&v(M)?(H(),p("div",D,[h("div",A,[h("div",w,[h("h2",j,f(ie(v(M).type)),1),h("p",x,f((a=v(M).timestamp,new Date(a).toLocaleString("zh-CN"))),1)]),h("div",C,[h("button",{class:"btn-secondary",onClick:t[0]||(t[0]=(...e)=>v(ee)&&v(ee)(...e))},[...t[4]||(t[4]=[h("span",{class:"back-icon"},"â†",-1),h("span",{class:"back-text"},"è¿”å›",-1)])])])]),h("div",E,[h("div",S,[t[5]||(t[5]=h("h3",{class:"section-subtitle"},"é—®é¢˜",-1)),h("p",_,f(v(M).question),1)]),h("div",q,[t[6]||(t[6]=h("h3",{class:"section-subtitle"},"ç»“æœ",-1)),R(e,{type:v(M).type,result:{...v(M).result,id:v(M).id},"conversation-history":v(M).conversationHistory||[],error:v(se)(v(M)),onRetry:t[1]||(t[1]=e=>v(te)(v(M)))},null,8,["type","result","conversation-history","error"])]),v(M).conversationHistory&&v(M).conversationHistory.length>0?(H(),p("div",N,[t[7]||(t[7]=h("h3",{class:"section-subtitle"},"AIå¯¹è¯",-1)),h("div",O,[(H(!0),p(g,null,k(v(M).conversationHistory.filter(e=>"system"!==e.role),(e,s)=>(H(),p("div",{key:e.id||s,class:I(["chat-message",`message-${e.role}`])},[h("div",T,f(e.content),1)],2))),128))])])):m("",!0)]),h("div",B,[h("button",{class:"btn-danger",onClick:t[2]||(t[2]=e=>v(Z)(v(M).id))},[...t[8]||(t[8]=[h("span",{class:"delete-icon"},"ğŸ—‘ï¸",-1),h("span",{class:"delete-text"},"åˆ é™¤è®°å½•",-1)])])])])):(H(),p("div",$,[t[10]||(t[10]=h("div",{class:"card-header"},[h("h2",{class:"page-title"},"å†å²è®°å½•"),h("p",{class:"content-text"},"è¿™é‡Œä¿å­˜äº†æ‚¨æœ€è¿‘çš„å åœè®°å½•ï¼Œä»…ä¿å­˜åœ¨æœ¬åœ°å“¦ã€‚")],-1)),h("div",z,[0===v(K).length?(H(),p("div",J,[...t[9]||(t[9]=[h("div",{class:"empty-icon"},"ğŸ“œ",-1),h("p",null,"æš‚æ— å†å²è®°å½•",-1),h("p",{class:"empty-hint"},"æ‚¨çš„å åœè®°å½•å°†ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ",-1)])])):(H(),p("div",L,[(H(!0),p(g,null,k(v(K),e=>(H(),p("div",{key:e.id,class:"history-item"},[h("button",{class:"history-item-button",onClick:s=>v(W)(e)},[h("div",U,[h("span",Y,f(ie(e.type)),1),h("span",F,f(ae(e.timestamp)),1)]),h("div",V,f(e.question),1)],8,P)]))),128))]))]),v(K).length>0?(H(),p("div",G,[h("button",{class:"btn-danger",onClick:t[3]||(t[3]=(...e)=>v(X)&&v(X)(...e))},"æ¸…ç©ºå†å²è®°å½•")])):m("",!0)]))]);var a}}}),[["__scopeId","data-v-926dd6f6"]]);export{K as default};
