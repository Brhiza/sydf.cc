const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-xHaJBDbl.js","assets/index-COsFyR_m.css"])))=>i.map(i=>d[i]);
import{d as q,l as g,q as H,o as B,c as a,b as s,t as v,f as L,m as $,F as O,r as P,E as f,u as T,G as J,J as S,e as l,_ as z}from"./index-xHaJBDbl.js";import{D as F}from"./DivinationResult-B2G56S14.js";const K={class:"page-container"},M={key:0,class:"content-card"},G={class:"detail-header"},j={class:"header-left"},Q={class:"section-title"},U={class:"detail-date"},W={class:"detail-content"},X={class:"detail-question"},Y={class:"content-text"},Z={class:"detail-result"},tt={class:"form-actions"},et={key:1,class:"content-card"},st={class:"history-content"},ot={key:0,class:"empty-message"},nt={key:1,class:"history-list"},it=["onClick"],at={class:"item-header"},lt={class:"item-type"},rt={class:"item-date"},ct={class:"item-question"},dt={key:0,class:"form-actions"},ut=q({__name:"HistoryView",props:{selectedRecordId:{type:String,default:null},showDetail:{type:Boolean,default:!1}},setup(R){const y=R,_=T(),r=g([]),n=g(null),h=g(!1);function k(){if(r.value=f.getRecords(),y.selectedRecordId){const e=r.value.find(t=>t.id===y.selectedRecordId);e?n.value=e:_.push("/history")}}function w(e){_.push(`/divination/${e.type}?historyId=${e.id}`)}function b(){confirm("确定要清空所有历史记录吗？此操作不可撤销。")&&(f.clearRecords(),r.value=[])}function A(e){confirm("确定要删除这条记录吗？此操作不可撤销。")&&(f.deleteRecord(e),I())}function I(){_.push("/history")}function x(e){return new Date(e).toLocaleDateString("zh-CN")}function E(e){return new Date(e).toLocaleString("zh-CN")}function D(e){const t=J(e);return t?t.title:"未知占卜"}function C(e){return e.result.aiResponse?["抱歉","暂时不可用","请稍后重试","出小差","请求过于频繁","服务器暂时繁忙"].some(i=>{var d;return(d=e.result.aiResponse)==null?void 0:d.includes(i)})?e.result.aiResponse:null:"AI解读暂时不可用，请稍后重试"}async function N(e){if(!h.value){h.value=!0;try{const{AIService:t}=await S(async()=>{const{AIService:c}=await import("./index-xHaJBDbl.js").then(u=>u.R);return{AIService:c}},__vite__mapDeps([0,1])),{DivinationService:o}=await S(async()=>{const{DivinationService:c}=await import("./index-xHaJBDbl.js").then(u=>u.S);return{DivinationService:c}},__vite__mapDeps([0,1])),i=t,m=o.getInstance().generatePrompt(e.type,e.question,e.result.data),p=await i.generateResponse(m);if(p!=null&&p.content){e.result.aiResponse=p.content;const c=f.getRecords(),u=c.findIndex(V=>V.id===e.id);u!==-1&&(c[u]=e,localStorage.setItem("sydf-history",JSON.stringify(c))),console.log("历史记录AI解读重试成功")}else throw new Error("AI服务返回空响应")}catch(t){console.error("重试AI解读失败:",t);const o=t instanceof Error?t.message:"重新生成失败，请稍后重试";e.result.aiResponse=o;const i=f.getRecords(),d=i.findIndex(m=>m.id===e.id);d!==-1&&(i[d]=e,localStorage.setItem("sydf-history",JSON.stringify(i)))}finally{h.value=!1}}}return H(()=>y.selectedRecordId,e=>{if(e){const t=r.value.find(o=>o.id===e);t&&(n.value=t)}else n.value=null}),B(()=>{k()}),(e,t)=>(l(),a("div",K,[R.showDetail&&n.value?(l(),a("div",M,[s("div",G,[s("div",j,[s("h2",Q,v(D(n.value.type)),1),s("p",U,v(E(n.value.timestamp)),1)]),s("div",{class:"header-actions"},[s("button",{class:"btn-secondary",onClick:I},t[2]||(t[2]=[s("span",{class:"back-icon"},"←",-1),s("span",{class:"back-text"},"返回",-1)]))])]),s("div",W,[s("div",X,[t[3]||(t[3]=s("h3",{class:"section-subtitle"},"问题",-1)),s("p",Y,v(n.value.question),1)]),s("div",Z,[t[4]||(t[4]=s("h3",{class:"section-subtitle"},"结果",-1)),L(F,{type:n.value.type,result:n.value.result,error:C(n.value),onRetry:t[0]||(t[0]=o=>N(n.value))},null,8,["type","result","error"])])]),s("div",tt,[s("button",{class:"btn-danger",onClick:t[1]||(t[1]=o=>A(n.value.id))},t[5]||(t[5]=[s("span",{class:"delete-icon"},"🗑️",-1),s("span",{class:"delete-text"},"删除记录",-1)]))])])):(l(),a("div",et,[t[7]||(t[7]=s("div",{class:"card-header"},[s("h2",{class:"page-title"},"历史记录"),s("p",{class:"content-text"},"这里保存了您最近的占卜记录，仅保存在本地哦。")],-1)),s("div",st,[r.value.length===0?(l(),a("div",ot,t[6]||(t[6]=[s("div",{class:"empty-icon"},"📜",-1),s("p",null,"暂无历史记录",-1),s("p",{class:"empty-hint"},"您的占卜记录将会显示在这里",-1)]))):(l(),a("div",nt,[(l(!0),a(O,null,P(r.value,o=>(l(),a("div",{key:o.id,class:"history-item"},[s("button",{class:"history-item-button",onClick:i=>w(o)},[s("div",at,[s("span",lt,v(D(o.type)),1),s("span",rt,v(x(o.timestamp)),1)]),s("div",ct,v(o.question),1)],8,it)]))),128))]))]),r.value.length>0?(l(),a("div",dt,[s("button",{class:"btn-danger",onClick:b},"清空历史记录")])):$("",!0)]))]))}}),pt=z(ut,[["__scopeId","data-v-c8d355e3"]]);export{pt as default};
