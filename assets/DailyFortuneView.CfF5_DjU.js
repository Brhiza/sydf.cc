import{d as e,r as a,i as t,o as s,c as l,m as n,g as o,u as r,s as i,b as u,q as d,F as c,l as v,t as y,j as m,v as p,I as g,w as h,J as f,n as D,e as w}from"./vendor.BOsypETj.js";import{s as k,h as S,d as I,_ as R}from"./index.C5qkYYYn.js";import{D as U}from"./DivinationInput.DKi4FfBn.js";import{D as b}from"./DailyResult.D8XQ36TN.js";import"./utils.kTIex7DX.js";const T="daily_fortune_limit";class C{static hasUsedToday(){const e=new Date,a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),t=this.getRecord();return t.date===a&&t.hasUsed}static markAsUsed(){const e=new Date,a={date:e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),hasUsed:!0,timestamp:Date.now()};k.setItem(T,a)}static getRecord(){const e=k.getItem(T);return e||{date:"",hasUsed:!1,timestamp:0}}static canDrawToday(){return!this.hasUsedToday()}static getTimeUntilNextDraw(){if(this.canDrawToday())return{canDraw:!0,hoursRemaining:0,minutesRemaining:0,message:"ç°åœ¨å¯ä»¥æŠ½å–ä»Šæ—¥è¿åŠ¿"};const e=new Date,a=new Date(e);a.setDate(a.getDate()+1),a.setHours(0,0,0,0);const t=a.getTime()-e.getTime(),s=Math.floor(t/36e5),l=Math.floor(t%36e5/6e4);let n="";return n=s>0?`è·ç¦»ä¸‹æ¬¡å¯æŠ½å–è¿˜æœ‰ ${s} å°æ—¶${l>0?` ${l} åˆ†é’Ÿ`:""}`:`è·ç¦»ä¸‹æ¬¡å¯æŠ½å–è¿˜æœ‰ ${l} åˆ†é’Ÿ`,{canDraw:!1,hoursRemaining:s,minutesRemaining:l,message:n}}static getTodayStatus(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),s=e.date===t&&e.hasUsed;let l,n;if(s&&(l=new Date(e.timestamp).toLocaleString("zh-CN")),!this.canDrawToday()){const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),n=e.toLocaleString("zh-CN")}const o={hasUsed:s,canDraw:this.canDrawToday()};return l&&(o.usedTime=l),n&&(o.nextAvailableTime=n),o}static resetRecord(){k.removeItem(T)}static cleanupExpiredRecord(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");e.date!==t&&k.removeItem(T)}static getUsageStats(){const e=this.getRecord(),a={totalDays:e.hasUsed?1:0,currentStreak:e.hasUsed?1:0};return e.hasUsed&&(a.lastUsedDate=e.date),a}}const A={class:"page-container"},F={key:1,class:"result-header-actions"},x={key:2,class:"content-card"},_={key:0,class:"ai-loading"},M={class:"fortune-result"},j={key:1,class:"result-actions"},E={key:3,class:"content-card"},N={class:"conversation-section"},$={class:"conversation-history"},q={key:0,class:"loading-dots"},Y={key:1,class:"message-content"},H={key:0,class:"error-state"},J={class:"error-content"},O={class:"error-line-2"},z={key:4,class:"ai-actions"},K={key:5,class:"content-card follow-up-card"},L={class:"follow-up-input"},P=["disabled","onKeydown"],V=["disabled"],W={key:0},B={key:1},G=R(e({__name:"DailyFortuneView",setup(e){const k=i(),R=a(!1),T=a(!1),G=a(null),Q=a(""),X=a(!1),Z=a(null),ee=a([]),ae=a(""),te=a(!1),se=a(!1),le=a(null),ne=["æ­£åœ¨è§£æå¤©æœºï¼Œè¯·ç¨å€™...","å¥‡é—¨éç”²æ’ç›˜ä¸­...","AIå¤§å¸ˆæ­£åœ¨ä¸ºæ‚¨è§£è¯»è¿åŠ¿...","æ­£åœ¨åˆ†æä»Šæ—¥å‰å‡¶...","æ­£åœ¨è®¡ç®—å¹¸è¿å…ƒç´ ..."],oe=t(()=>""!==Q.value),re=t(()=>{const e=Math.floor(Math.random()*ne.length);return ne[e]}),ie=t(()=>!1),ue=t(()=>{if(0===ee.value.length)return!1;return ee.value.filter(e=>"system"!==e.role).filter((e,a)=>fe(e,a)).length>0||te.value}),de=t(()=>{if(!Q.value)return null;try{const e=Q.value.trim();if(e.startsWith("{")&&e.endsWith("}")){return JSON.parse(e)}const a=Q.value.match(/```json\s*([\s\S]*?)\s*```/);if(a){return JSON.parse(a[1])}return null}catch(e){return null}});function ce(){const e=S.findTodayDailyFortune();if(e){const a=e.result.data;G.value=a,Q.value=e.result.aiResponse||"",ee.value=e.conversationHistory||[],X.value=!0,C.hasUsedToday()||C.markAsUsed()}else X.value=!1,ee.value=[]}function ve(){ye()}async function ye(e=!1){if(R.value)return;const a=S.findTodayDailyFortune();if(a&&!e){const e=a.result.data;return G.value=e,Q.value=a.result.aiResponse||"",X.value=!0,void(C.hasUsedToday()||C.markAsUsed())}if(a&&e){const e=a.result.data;G.value=e,X.value=!0,T.value=!0,R.value=!1,Q.value="";try{await I.startDivination({type:"daily",question:"è¯·ä¸ºæˆ‘åˆ†æä»Šæ—¥è¿åŠ¿",supplementaryInfo:{}},{onInitialResult:()=>{T.value=!0},onAIChunk:e=>{Q.value+=e},onAIComplete:e=>{Q.value=e.aiResponse||"",T.value=!1,R.value=!1,a.result.aiResponse=e.aiResponse||"",S.updateRecord(a.id,a)},onAIError:e=>{T.value=!1,R.value=!1,Z.value=e},onConversationUpdate:()=>{}})}catch(t){T.value=!1,R.value=!1,alert("è¿åŠ¿è§£è¯»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}return}R.value=!0,T.value=!1,X.value=!1,Q.value="";try{await I.startDivination({type:"daily",question:"è¯·ä¸ºæˆ‘åˆ†æä»Šæ—¥è¿åŠ¿",supplementaryInfo:{}},{onInitialResult:e=>{G.value=e.data,T.value=!0},onAIChunk:e=>{Q.value+=e},onAIComplete:e=>{Q.value=e.aiResponse||"",T.value=!1,R.value=!1,C.markAsUsed()},onAIError:e=>{T.value=!1,R.value=!1,Z.value=e},onConversationUpdate:()=>{}})}catch(t){T.value=!1,R.value=!1,alert("æŠ½å–è¿åŠ¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}}async function me(){if(confirm("ç¡®å®šè¦åˆ é™¤ä»Šæ—¥è¿åŠ¿å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œä¸å¯æ’¤é”€ã€‚"))try{const e=S.findTodayDailyFortune();e&&await S.deleteRecord(e.id);["daily_fortune_limit","sydf-history","daily-fortune-cache","today-fortune-result","fortune-cache-"+(new Date).toISOString().split("T")[0]].forEach(e=>{localStorage.removeItem(e)});for(let a=0;a<localStorage.length;a++){const e=localStorage.key(a);e&&(e.includes("fortune")||e.includes("daily")||e.includes("cache"))&&localStorage.removeItem(e)}G.value=null,Q.value="",X.value=!1,R.value=!1,T.value=!1,C.resetRecord(),await new Promise(e=>setTimeout(e,50)),ce(),await new Promise(e=>setTimeout(e,100)),alert("ä»Šæ—¥è¿åŠ¿å·²å½»åº•åˆ é™¤ï¼Œé¡µé¢å·²é‡ç½®")}catch(e){alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}}function pe(){G.value=null,Q.value="",X.value=!1,R.value=!1,T.value=!1}function ge(){le.value&&(le.value.abort(),se.value=!0,T.value=!1,te.value=!1)}function he(){Z.value=null,se.value=!1,G.value?ye(!0):ye()}function fe(e,a){return(0!==a||"user"!==e.role)&&(1!==a||"assistant"!==e.role)}function De(){if(!ae.value.trim()||te.value||!G.value)return;te.value=!0;const e=[...ee.value],a=ae.value.trim();ae.value="";const t=S.findTodayDailyFortune();let s="";if(!t)return Z.value="å åœè®°å½•å°šæœªä¿å­˜å®Œæˆï¼Œè¯·ç¨åå†è¯•",void(te.value=!1);s=t.id,I.sendFollowUp(s,e,a,{onChunk:()=>{},onComplete:()=>{te.value=!1},onError:e=>{Z.value=e,te.value=!1},onConversationUpdate:e=>{ee.value=e}})}return s(()=>{C.cleanupExpiredRecord(),ce()}),(e,a)=>(w(),l("div",A,[G.value||R.value?o("",!0):(w(),n(U,{key:0,title:"ä»Šæ—¥è¿åŠ¿",description:"åŸºäºæ—¥å®¶å¥‡é—¨éç”²ç®—æ³•ï¼Œä¸ºæ‚¨è§£æä»Šæ—¥çš„æ•´ä½“è¿åŠ¿ï¼ŒåŒ…å«äº‹ä¸šã€è´¢å¯Œã€æ„Ÿæƒ…ã€å¥åº·ç­‰å„æ–¹é¢çš„è¯¦ç»†æŒ‡å¯¼","button-text":"æŸ¥çœ‹ä»Šæ—¥è¿åŠ¿",loading:R.value,"loading-text":re.value,"divination-type":"daily","show-inspiration":!1,onSubmit:ve,onClear:pe},null,8,["loading","loading-text"])),G.value&&!r(k).query.historyId?(w(),l("div",F,[u("button",{class:"btn-secondary",onClick:pe},"â† è¿”å›")])):o("",!0),G.value?(w(),l("div",x,[a[2]||(a[2]=u("div",{class:"section-header"},[u("h2",{class:"section-title"},"ä»Šæ—¥è¿åŠ¿")],-1)),T.value?(w(),l("div",_,[...a[1]||(a[1]=[u("div",{class:"ai-loading-content"},[u("div",{class:"ai-loading-spinner"}),u("span",null,"AIå¤§å¸ˆæ­£åœ¨è§£è¯»è¿åŠ¿...")],-1)])])):o("",!0),u("div",M,[d(b,{"fortune-data":G.value,"ai-response":Q.value,"show-lucky":!0,"detailed-analysis":de.value},null,8,["fortune-data","ai-response","detailed-analysis"])]),ie.value?(w(),l("div",j,[u("button",{class:"btn-danger",onClick:me}," ğŸ—‘ï¸ åˆ é™¤ä»Šæ—¥è¿åŠ¿ ")])):o("",!0)])):o("",!0),G.value&&ue.value?(w(),l("div",E,[u("div",N,[a[5]||(a[5]=u("h3",{class:"section-title"},"AIå¯¹è¯",-1)),u("div",$,[(w(!0),l(c,null,v(ee.value.filter(e=>"system"!==e.role),(e,t)=>m((w(),l("div",{key:e.id||t,class:D(["chat-message",`message-${e.role}`])},["assistant"===e.role&&!e.content&&te.value?(w(),l("div",q,[...a[3]||(a[3]=[u("span",null,null,-1),u("span",null,null,-1),u("span",null,null,-1)])])):(w(),l("div",Y,y(e.content),1))],2)),[[f,fe(e,t)]])),128))]),Z.value?(w(),l("div",H,[u("div",J,[a[4]||(a[4]=u("div",{class:"error-line-1"},"å“ˆå“ˆï¼ŒAIå¼€å°å·®å’¯",-1)),u("div",O,y(Z.value),1),u("div",{class:"error-line-3"},[u("button",{class:"retry-button",onClick:he},"é‡æ–°ç”Ÿæˆè§£è¯»")])])])):o("",!0)])])):o("",!0),G.value?(w(),l("div",z,[T.value?(w(),l("button",{key:0,class:"btn-secondary",onClick:ge},"å–æ¶ˆç”Ÿæˆ")):o("",!0),T.value||!Z.value&&!se.value?o("",!0):(w(),l("button",{key:1,class:"btn-primary",onClick:he}," é‡æ–°ç”Ÿæˆ "))])):o("",!0),G.value&&oe.value&&!T.value?(w(),l("div",K,[u("div",L,[m(u("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>ae.value=e),placeholder:"å¯¹ä»Šæ—¥è¿åŠ¿è¿›è¡Œè¿½é—®...",disabled:te.value,onKeydown:g(h(De,["prevent"]),["enter"])},null,40,P),[[p,ae.value]]),u("button",{disabled:te.value,onClick:De},[te.value?(w(),l("span",B,"å‘é€ä¸­...")):(w(),l("span",W,"å‘é€"))],8,V)])])):o("",!0)]))}}),[["__scopeId","data-v-73130bce"]]);export{G as default};
