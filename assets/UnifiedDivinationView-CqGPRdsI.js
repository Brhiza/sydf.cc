import{d as K,S as O,b as p,e as V,g as Q,f as z,w as E,h as X,c as r,i as R,a as s,j as x,t as b,F as W,r as j,k as m,l as ee,v as se,n as te,m as oe,M as ne,p as ae,q as B,s as Y,E as J,x as le,o as l,_ as Z,u as ie,y as F,z as P,A as ue,D as re,B as ce}from"./index-BC5h_unE.js";import{g as de}from"./divination-config-DPDDIOby.js";const ve={class:"ssgw-result"},pe={key:0,class:"shaking-process"},ge={class:"result-section"},fe={key:0},ye={key:1,class:"tossing-process"},he={class:"result-section"},_e={key:0,class:"result-section"},me=["innerHTML"],Re={key:0},we={key:1},ke={key:1,class:"bei-container"},Se=["src","alt"],be={class:"button-wrapper"},qe=["disabled"],Te={key:2,class:"final-result"},Ie={key:0,class:"debug-info"},De={key:1,class:"sign-container"},Ae={class:"sign-header"},$e={class:"sign-title"},Me={class:"sign-content"},Ne={class:"sign-story"},Ve={class:"story-content"},Ce={class:"sign-details"},He={class:"details-grid"},xe={class:"detail-label"},Be={class:"detail-value"},Ee={key:2,class:"ai-section"},Le={class:"ai-card"},Ue={class:"ai-input-section"},Ge=["disabled"],Pe={key:0},Fe={key:1,class:"loading-text"},ze={key:3,class:"ai-response-section"},Oe={class:"ai-response"},Qe=K({__name:"SsgwResult",props:{question:{},loading:{type:Boolean,default:!1},error:{default:null}},setup(M){const h=M,D=z(),f=O.length,u=p("result"),_=p("请静心默念，准备摇签..."),o=p(0),w=p(0),d=p(!1),A=p(!0),T=p([]),k=p(""),I=p(""),y=p(""),q=p(!1),$=p(""),c=V(()=>{if(o.value===0)return console.log("signData computed - currentQian is 0"),null;const t=Q(o.value);return console.log("signData computed - 签号:",o.value,"签文:",t),t}),a=V(()=>!(D.query.historyId||y.value));function S(){u.value="shaking",_.value="正在摇签中...",setTimeout(()=>{o.value=Math.floor(Math.random()*O.length)+1,u.value="tossing",w.value=0,A.value=!1},2e3)}function L(){if(d.value)return;d.value=!0,T.value=[],k.value="";const t=ae();setTimeout(()=>{T.value=[t.bei1,t.bei2];const e=t.result;e==="圣杯"&&(A.value=!0),e==="圣杯"?(k.value="<strong>圣杯</strong> (一平一凸) - 神明同意此签。",setTimeout(()=>{k.value+="<p>正在为您解读签文...</p>",setTimeout(()=>{u.value="result",C()},2e3)},1e3)):(w.value++,e==="笑杯"?k.value="<strong>笑杯</strong> (两平) - 神明笑而不语，可能问题不明或时机未到。":k.value="<strong>阴杯</strong> (两凸) - 神明不同意此签。",w.value>=3?(k.value+="<p>您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。</p>",d.value=!1):(k.value+="<p>请重新为您摇签...</p>",setTimeout(()=>{S()},2e3))),d.value=!1},1300)}function C(){if(c.value)try{const t=h.question==="心中所想之事"?"三山国王灵签":h.question,e=B.addRecord({type:"ssgw",question:t,result:{type:"ssgw",data:{sign:{id:o.value,title:c.value.title,qianwen:c.value.qianwen,story:c.value.story,details:c.value.details}},aiResponse:y.value||void 0}});$.value=e.id,Y.emit(J.HISTORY_UPDATED,e),console.log("三山国王灵签历史记录已保存")}catch(t){console.error("保存历史记录失败:",t)}}async function U(){if(q.value||!c.value)return;q.value=!0;const t=I.value.trim()||"请结合我最初的问题，为我详细解读这支签。",e=`
您是一位精通中国传统文化和解签的AI大师。请根据以下信息，为用户提供详细、富有同理心和启发性的解答。

用户最初的问题是："${h.question}"
用户抽到了【三山国王灵签】第 ${o.value} 签：${c.value.title}
签文是："${c.value.qianwen}"
典故是："${c.value.story}"
详细解签包括：${Object.entries(c.value.details).map(([g,v])=>`${g}：${v}`).join("；")}

现在，用户追问了一个问题："${t}"

请遵循以下指引进行回答：
1. **结合问题**：将你的回答与用户最初的问题和追问的问题紧密结合。
2. **深入解读**：不要仅仅重复签文的字面意思，要深入挖掘其背后的象征意义和智慧。
3. **提供建议**：在分析的基础上，提供具体、积极、可行的行动建议。
4. **温暖鼓励**：用温暖、鼓励和富有同理心的语气进行回答，给予用户支持和力量。
5. **格式清晰**：使用分段和重点标识，让回答易于阅读。
  `;try{const v=await le().generateResponse(e);y.value=v.content||"抱歉，AI解读暂时不可用。",n()}catch(g){console.error("AI解读失败:",g),y.value="AI解读暂时不可用，请稍后再试。"}finally{q.value=!1}}function n(){if(!(!$.value||!y.value))try{const t=B.getRecord($.value);if(t){t.result.aiResponse=y.value;const e=B.getRecords();localStorage.setItem("sydf-history",JSON.stringify(e)),Y.emit(J.HISTORY_UPDATED,t),console.log("历史记录AI解读已更新:",$.value)}}catch(t){console.error("更新历史记录AI解读失败:",t)}}function i(t){var e,g;try{const v=B.getRecord(t);if(v&&v.type==="ssgw"&&((g=(e=v.result)==null?void 0:e.data)!=null&&g.sign)){const G=v.result.data.sign;return o.value=G.id,u.value="result",v.result.aiResponse&&(y.value=v.result.aiResponse),console.log("从历史记录加载三山国王灵签:",G.id,G.title),!0}}catch(v){console.error("加载历史记录失败:",v)}return!1}function N(){const t=D.query.historyId;t&&i(t)||H()}function H(){const t=window.ssgwQianNumber;console.log("SsgwResult - 接收到的签号:",t),t&&t>0?(o.value=t,u.value="result",delete window.ssgwQianNumber,C()):(o.value=Math.floor(Math.random()*61)+1,u.value="result",C()),console.log("SsgwResult - 设置的签号:",o.value),console.log("SsgwResult - 签文数据:",Q(o.value))}return E(()=>D.query.historyId,(t,e)=>{console.log("SsgwResult - 历史记录ID变化:",e,"->",t),t!==e&&(y.value="",I.value="",$.value="",N())},{immediate:!1}),X(()=>{N()}),(t,e)=>(l(),r("div",ve,[u.value==="shaking"?(l(),r("div",pe,[s("div",ge,[t.question!=="心中所想之事"?(l(),r("p",fe,[e[1]||(e[1]=x("您的问题是：")),s("strong",null,b(t.question),1)])):R("",!0),s("p",null,b(_.value),1)])])):R("",!0),u.value==="tossing"?(l(),r("div",ye,[s("div",he,[s("p",null,[e[2]||(e[2]=x("求得第 ")),s("strong",null,b(o.value),1),e[3]||(e[3]=x(" 签。"))]),e[4]||(e[4]=s("p",null,"请投掷圣杯，询问三山国王是否同意此签...",-1))]),k.value?(l(),r("div",_e,[s("p",{innerHTML:k.value},null,8,me),w.value>=3&&!A.value?(l(),r("p",Re,"您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。")):A.value?R("",!0):(l(),r("p",we,"请重新为您摇签..."))])):R("",!0),T.value.length>0?(l(),r("div",ke,[(l(!0),r(W,null,j(T.value,(g,v)=>(l(),r("img",{key:v,src:`/static/${g}.png`,alt:g,class:"bei-image"},null,8,Se))),128))])):R("",!0),s("div",be,[s("button",{onClick:L,disabled:d.value,class:"toss-button"},b(d.value?"投掷中...":"投掷圣杯"),9,qe)])])):R("",!0),u.value==="result"?(l(),r("div",Te,[c.value?R("",!0):(l(),r("div",Ie,[e[5]||(e[5]=s("p",null,"调试信息：",-1)),s("p",null,"当前签号："+b(o.value),1),s("p",null,"签文数据："+b(c.value),1),s("p",null,"SSGW_SIGNS长度："+b(m(f)),1)])),c.value?(l(),r("div",De,[s("div",Ae,[s("h3",$e,b(c.value.title),1),s("div",Me,[s("p",null,[e[6]||(e[6]=s("strong",null,"签文：",-1)),x(b(c.value.qianwen),1)])])]),s("div",Ne,[e[7]||(e[7]=s("h4",{class:"section-title"},"典故",-1)),s("p",Ve,b(c.value.story),1)]),s("div",Ce,[e[8]||(e[8]=s("h4",{class:"section-title"},"详细解签",-1)),s("div",He,[(l(!0),r(W,null,j(c.value.details,(g,v)=>(l(),r("div",{key:v,class:"detail-item"},[s("span",xe,b(v)+"：",1),s("span",Be,b(g),1)]))),128))])])])):R("",!0),a.value?(l(),r("div",Ee,[s("div",Le,[e[10]||(e[10]=s("div",{class:"ai-header"},[s("h2",{class:"ai-card-title"},"三山国王"),s("p",{class:"ai-card-description"},"三山国王是中国传统的占卜方式，通过卦象阴阳变化来预测事物的发展趋势")],-1)),s("div",Ue,[ee(s("input",{"onUpdate:modelValue":e[0]||(e[0]=g=>I.value=g),type:"text",placeholder:"请输入您想要占卜的问题",class:"ai-input"},null,512),[[se,I.value]]),s("button",{onClick:U,disabled:q.value,class:te(["ask-ai-button",{"ai-thinking":q.value}])},[q.value?(l(),r("span",Fe,e[9]||(e[9]=[x(" 思考中 "),s("span",{class:"loading-dots"},[s("span",{class:"dot"}),s("span",{class:"dot"}),s("span",{class:"dot"})],-1)]))):(l(),r("span",Pe,"询问赛博大师"))],10,Ge)])])])):R("",!0),y.value?(l(),r("div",ze,[s("div",Oe,[oe(ne,{content:y.value},null,8,["content"])])])):R("",!0)])):R("",!0)]))}}),We=Z(Qe,[["__scopeId","data-v-cb346542"]]);function je(M){const h=z(),D=ie(),f=p(""),u=p(!1),_=p(null),o=p(""),w=p(null),d=p(!1),A=V(()=>_.value!==null),T=V(()=>o.value!=="");async function k(){if(!(u.value||!f.value.trim())){u.value=!0,d.value=!0,w.value=null,_.value=null,o.value="";try{const a=await F({type:M,question:f.value.trim()},S=>{o.value=S});_.value={type:a.type,data:a.data,aiResponse:""},u.value=!1,a.aiResponse&&(o.value=a.aiResponse)}catch(a){console.error("占卜失败:",a),w.value=a instanceof Error?a.message:"占卜失败，请稍后重试",u.value=!1}finally{d.value=!1}}}function I(){_.value=null,o.value="",w.value=null,f.value=""}function y(a){const S=B.getRecord(a);S?(console.log("加载历史记录:",S),f.value=S.question,_.value=S.result,o.value=S.result.aiResponse||""):(console.error("未找到历史记录:",a),D.push(`/divination/${M}`))}async function q(){if(!(!_.value||d.value)){d.value=!0,w.value=null;try{const a=await F({type:M,question:f.value},S=>{o.value=S});o.value=a.aiResponse||"",_.value&&(_.value.aiResponse=a.aiResponse)}catch(a){console.error("重新生成AI解读失败:",a),w.value="重新生成失败，请稍后重试"}finally{d.value=!1}}}function $(){const a=h.query.historyId;a&&y(a)}function c(){if(h.query.historyId){const a={...h.query};delete a.historyId,D.replace({path:h.path,query:a})}}return{question:f,isLoading:u,result:_,aiResponse:o,error:w,isAiLoading:d,hasResult:A,hasAiResponse:T,startDivination:k,clearResult:I,loadFromHistory:y,regenerateAI:q,handleHistoryParam:$,clearHistoryParam:c}}const Ye={class:"unified-divination-view"},Je={class:"divination-container"},Ke={key:1},Xe={key:2,class:"error-message"},Ze=K({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(M){const h=M,D=z(),f=V(()=>de(h.divinationType)),{question:u,isLoading:_,result:o,aiResponse:w,error:d,isAiLoading:A,hasResult:T,startDivination:k,clearResult:I,handleHistoryParam:y,clearHistoryParam:q}=je(h.divinationType),$=V(()=>o.value?{data:o.value.data,aiResponse:w.value}:{data:{},aiResponse:""}),c=p("single");function a(n){if(console.log("类型变化:",n),n.startsWith("tarot_")){const i=n.replace("tarot_","");c.value=i,console.log("牌阵类型更新为:",i)}}async function S(n){try{const i=await F({type:"tarot",question:n,spreadType:c.value},N=>{w.value=N});o.value=i}catch(i){console.error("塔罗牌占卜失败:",i),d.value=i instanceof Error?i.message:"塔罗牌占卜失败，请稍后重试"}}function L(n){const i=n||u.value;if(console.log("UnifiedDivinationView handleSubmit:",i),h.divinationType==="ssgw"){n&&(u.value=n),o.value={type:"ssgw",data:{qianNumber:window.ssgwQianNumber||Math.floor(Math.random()*100)+1},aiResponse:""};return}i&&i.trim()?(n&&(u.value=n),h.divinationType==="tarot"?S(i):k()):console.error("提交的问题为空")}function C(){I(),q()}function U(){d.value=null}return E(()=>h.divinationType,(n,i)=>{i&&n!==i&&(console.log("占卜类型变化:",i,"->",n),console.log("新配置:",f.value),I(),q())}),E(f,n=>{console.log("配置更新:",n)}),E(()=>D.query.historyId,(n,i)=>{console.log("路由查询参数变化:",{oldId:i,newId:n}),n&&typeof n=="string"?(console.log("检测到历史记录参数:",n),y()):i&&!n&&(console.log("从历史记录模式切换到新建模式"),I())},{immediate:!0}),X(()=>{console.log("UnifiedDivinationView mounted, type:",h.divinationType),y()}),(n,i)=>{var N,H,t,e,g;return l(),r("div",Ye,[s("div",Je,[!m(T)&&!m(_)?(l(),P(re,{key:0,title:((N=f.value)==null?void 0:N.title)||"",description:((H=f.value)==null?void 0:H.description)||"","button-text":((t=f.value)==null?void 0:t.buttonText)||"开始占卜",loading:m(_),placeholder:((e=f.value)==null?void 0:e.placeholder)||"",examples:((g=f.value)==null?void 0:g.examples)||[],"divination-type":n.divinationType,modelValue:m(u),"onUpdate:modelValue":i[0]||(i[0]=v=>ue(u)?u.value=v:null),onSubmit:L,onTypeChange:a,"hide-after-submit":!1},null,8,["title","description","button-text","loading","placeholder","examples","divination-type","modelValue"])):R("",!0),m(T)?(l(),r("div",Ke,[m(D).query.historyId?R("",!0):(l(),r("button",{key:0,onClick:C,class:"back-button"}," ← 返回 ")),n.divinationType==="ssgw"?(l(),P(We,{key:1,question:m(u),loading:m(A),error:m(d)},null,8,["question","loading","error"])):(l(),P(ce,{key:2,type:n.divinationType,result:$.value,loading:m(A),error:m(d)},null,8,["type","result","loading","error"]))])):R("",!0),m(d)&&!m(T)?(l(),r("div",Xe,[s("p",null,b(m(d)),1),s("button",{onClick:U,class:"retry-button"},"重试")])):R("",!0)])])}}}),ts=Z(Ze,[["__scopeId","data-v-1dd16c74"]]);export{ts as default};
