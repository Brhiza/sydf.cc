import{i as e,r as a,s as n,x as l,d as i,p as t,o,c as s,m as u,g as r,u as v,K as d,b as p,t as c,j as y,v as f,I as m,w as g,e as h,L as b}from"./vendor.BOsypETj.js";import{D as w}from"./DivinationInput.C3gCRlb7.js";import{D as R}from"./DivinationResult.BUBwWTxs.js";import{h as I,d as k,p as C,g as T,e as q,E as U,_ as x}from"./index.C-qxr2xH.js";import"./utils.CwRxlNlL.js";import"./markdown.CaxBdgEJ.js";import"./DailyResult.BoPrrIn1.js";const A={key:1,class:"result-header-actions"},H={key:3,class:"ai-actions"},S={key:4,class:"content-card error-card"},_={class:"content-text"},j={key:5,class:"content-card follow-up-card"},D={class:"follow-up-input"},L=["disabled"],N=["disabled"],E={key:0},F={key:1},O=x(i({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(i){const x=i,O=n(),V=e(()=>T(x.divinationType)),J=a(null),{question:P,isLoading:G,result:K,aiResponse:Q,error:W,isAiLoading:Y,hasResult:$,hasAiResponse:z,viewingHistory:B,isCancelled:M,startDivination:X,clearResult:Z,regenerateAI:ee,handleHistoryParam:ae,clearHistoryParam:ne,cancelGeneration:le,conversationHistory:ie,followUpQuestion:te,isFollowUpLoading:oe,handleSendFollowUp:se}=function(i){const t=n(),o=l(),s=e(()=>i.divinationType),u=a(""),r=a(!1),v=a(null),d=a(""),p=a(null),c=a(!1),y=a(!1),f=a(null),m=a(!1),g=a([]),h=a(""),b=a(!1),w=e(()=>null!==v.value),R=e(()=>""!==d.value);async function T(e={}){if(r.value||!u.value.trim())return;r.value=!0,c.value=!0,p.value=null,v.value=null,d.value="",m.value=!1,f.value=new AbortController,g.value=[];const{supplementaryInfo:a,...n}=e,l={type:s.value,question:u.value.trim(),...n,signal:f.value.signal};a&&(l.supplementaryInfo=a),C(l,{onInitialResult:e=>{v.value=e,r.value=!1},onAIChunk:e=>{d.value+=e},onAIComplete:e=>{c.value=!1,v.value&&(v.value.aiResponse=e.aiResponse||"")},onAIError:e=>{p.value=e,c.value=!1,r.value=!1},onConversationUpdate:e=>{g.value=e}})}function q(e){y.value=!0;const a=I.getRecord(e);a?(u.value=a.question,v.value=JSON.parse(JSON.stringify(a.result)),d.value=a.result.aiResponse||"",g.value=a.conversationHistory||[]):o.push(`/divination/${s.value}`)}return{question:u,isLoading:r,result:v,aiResponse:d,error:p,isAiLoading:c,viewingHistory:y,isCancelled:m,conversationHistory:g,followUpQuestion:h,isFollowUpLoading:b,hasResult:w,hasAiResponse:R,startDivination:T,clearResult:function(){v.value=null,d.value="",p.value=null,u.value="",y.value=!1,g.value=[],h.value=""},loadResultFromHistory:q,regenerateAI:async function(){u.value&&await T()},clearHistoryParam:function(){if(t.query.historyId){const e={...t.query};delete e.historyId,o.replace({path:t.path,query:e})}},cancelGeneration:function(){f.value&&(f.value.abort(),m.value=!0,c.value=!1,b.value=!1)},handleSendFollowUp:function(){if(!h.value.trim()||b.value||!v.value)return;b.value=!0;const e=[...g.value],a=h.value.trim();h.value="";let n="";if("daily"===s.value){const e=I.findTodayDailyFortune();e&&(n=e.id)}else{const e=I.getRecords().find(e=>e.result.data&&v.value?.data&&JSON.stringify(e.result.data)===JSON.stringify(v.value.data)&&e.type===s.value);n=e?e.id:v.value.id}if(!n)return p.value="无法找到占卜记录，请重新占卜后再试",void(b.value=!1);k.sendFollowUp(n,e,a,{onChunk:()=>{},onComplete:()=>{b.value=!1},onError:e=>{p.value=e,b.value=!1},onConversationUpdate:e=>{g.value=e}})},handleHistoryParam:function(){const e=t.query.historyId;e&&q(e)}}}(x),ue=e(()=>K.value?{data:K.value.data,aiResponse:Q.value}:{data:{},aiResponse:""}),re=a("single");function ve(e){if(e.startsWith("tarot_")){const a=e.replace("tarot_","");re.value=a}}function de(e){e.question&&(P.value=e.question);const a={};"tarot"===x.divinationType?a.spreadType=re.value:"ssgw"===x.divinationType&&void 0!==e.signNumber&&(a.signNumber=e.signNumber),e.supplementaryInfo&&(a.supplementaryInfo=e.supplementaryInfo),X(a)}function pe(){Z(),ne()}function ce(){W.value=null}function ye(){ee()}return t(()=>x.divinationType,(e,a)=>{!B.value&&a&&e!==a&&(Z(),ne(),P.value="",te.value="",ie.value=[],W.value=null,M.value=!1,async function(){await b(),J.value&&(J.value.scrollTop=0),window.scrollTo(0,0)}(),q.emit(U.HISTORY_SELECTION_RESET))},{immediate:!1}),t(V,()=>{}),t(()=>O.query.historyId,(e,a)=>{e&&"string"==typeof e?ae():a&&!e&&Z()},{immediate:!0}),o(()=>{ae()}),(e,a)=>(h(),s("div",{ref_key:"pageContainerRef",ref:J,key:i.divinationType,class:"page-container"},[v($)||v(G)?r("",!0):(h(),u(w,{key:0,modelValue:v(P),"onUpdate:modelValue":a[0]||(a[0]=e=>d(P)?P.value=e:null),title:V.value?.title||"",description:V.value?.description||"","button-text":V.value?.buttonText||"开始占卜",loading:v(G),placeholder:V.value?.placeholder||"",examples:V.value?.examples||[],"divination-type":i.divinationType,"hide-after-submit":!1,onSubmit:de,onTypeChange:ve,onClear:v(Z)},null,8,["modelValue","title","description","button-text","loading","placeholder","examples","divination-type","onClear"])),v($)&&!v(O).query.historyId?(h(),s("div",A,[p("button",{class:"btn-secondary",onClick:pe},"← 返回")])):r("",!0),v($)?(h(),u(R,{key:2,type:i.divinationType,result:ue.value,"is-ai-loading":v(Y)||v(oe),error:v(W),question:v(P),"conversation-history":v(ie),"is-follow-up-loading":v(oe),onRetry:ye},null,8,["type","result","is-ai-loading","error","question","conversation-history","is-follow-up-loading"])):r("",!0),v($)?(h(),s("div",H,[v(Y)?(h(),s("button",{key:0,class:"btn-secondary",onClick:a[1]||(a[1]=(...e)=>v(le)&&v(le)(...e))},"取消生成")):r("",!0),v(Y)||!v(W)&&!v(M)?r("",!0):(h(),s("button",{key:1,class:"btn-primary",onClick:ye}," 重新生成 "))])):r("",!0),v(W)&&!v($)?(h(),s("div",S,[p("p",_,c(v(W)),1),p("div",{class:"form-actions"},[p("button",{class:"btn-primary",onClick:ce},"重试")])])):r("",!0),v(z)&&!v(Y)?(h(),s("div",j,[p("div",D,[y(p("textarea",{"onUpdate:modelValue":a[2]||(a[2]=e=>d(te)?te.value=e:null),placeholder:"对AI的解读进行追问...",disabled:v(oe),onKeydown:a[3]||(a[3]=m(g((...e)=>v(se)&&v(se)(...e),["prevent"]),["enter"]))},null,40,L),[[f,v(te)]]),p("button",{disabled:v(oe),onClick:a[4]||(a[4]=(...e)=>v(se)&&v(se)(...e))},[v(oe)?(h(),s("span",F,"发送中...")):(h(),s("span",E,"发送"))],8,N)])])):r("",!0)]))}}),[["__scopeId","data-v-170807af"]]);export{O as default};
