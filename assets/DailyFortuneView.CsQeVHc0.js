import{d as e,r as a,i as t,o as s,c as l,m as n,g as o,u as i,s as r,b as u,q as d,F as c,l as v,t as y,j as m,v as p,I as g,w as h,n as f,e as D}from"./vendor.BUyyYNCK.js";import{s as w,h as k,d as S,_ as I}from"./index.BI4VrjYR.js";import{D as R}from"./DivinationInput.CYJMDpBW.js";import{D as U}from"./DailyResult.B8WlkHfK.js";import"./utils.CwRxlNlL.js";const b="daily_fortune_limit";class T{static hasUsedToday(){const e=new Date,a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),t=this.getRecord();return t.date===a&&t.hasUsed}static markAsUsed(){const e=new Date,a={date:e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),hasUsed:!0,timestamp:Date.now()};w.setItem(b,a)}static getRecord(){const e=w.getItem(b);return e||{date:"",hasUsed:!1,timestamp:0}}static canDrawToday(){return!this.hasUsedToday()}static getTimeUntilNextDraw(){if(this.canDrawToday())return{canDraw:!0,hoursRemaining:0,minutesRemaining:0,message:"现在可以抽取今日运势"};const e=new Date,a=new Date(e);a.setDate(a.getDate()+1),a.setHours(0,0,0,0);const t=a.getTime()-e.getTime(),s=Math.floor(t/36e5),l=Math.floor(t%36e5/6e4);let n="";return n=s>0?`距离下次可抽取还有 ${s} 小时${l>0?` ${l} 分钟`:""}`:`距离下次可抽取还有 ${l} 分钟`,{canDraw:!1,hoursRemaining:s,minutesRemaining:l,message:n}}static getTodayStatus(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),s=e.date===t&&e.hasUsed;let l,n;if(s&&(l=new Date(e.timestamp).toLocaleString("zh-CN")),!this.canDrawToday()){const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),n=e.toLocaleString("zh-CN")}const o={hasUsed:s,canDraw:this.canDrawToday()};return l&&(o.usedTime=l),n&&(o.nextAvailableTime=n),o}static resetRecord(){w.removeItem(b)}static cleanupExpiredRecord(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");e.date!==t&&w.removeItem(b)}static getUsageStats(){const e=this.getRecord(),a={totalDays:e.hasUsed?1:0,currentStreak:e.hasUsed?1:0};return e.hasUsed&&(a.lastUsedDate=e.date),a}}const C={class:"page-container"},A={key:1,class:"result-header-actions"},x={key:2,class:"content-card"},F={key:0,class:"ai-loading"},_={class:"fortune-result"},j={key:1,class:"result-actions"},M={key:3,class:"content-card"},E={class:"conversation-section"},N={key:0,class:"conversation-history"},$={key:0,class:"loading-dots"},q={key:1,class:"message-content"},Y={key:1,class:"error-state"},O={class:"error-content"},z={class:"error-line-2"},H={key:4,class:"ai-actions"},J={key:5,class:"content-card follow-up-card"},K={class:"follow-up-input"},L=["disabled","onKeydown"],P=["disabled"],V={key:0},W={key:1},B=I(e({__name:"DailyFortuneView",setup(e){const w=r(),I=a(!1),b=a(!1),B=a(null),G=a(""),Q=a(!1),X=a(null),Z=a([]),ee=a(""),ae=a(!1),te=a(!1),se=a(null),le=["正在解析天机，请稍候...","奇门遁甲排盘中...","AI大师正在为您解读运势...","正在分析今日吉凶...","正在计算幸运元素..."],ne=t(()=>""!==G.value),oe=t(()=>{const e=Math.floor(Math.random()*le.length);return le[e]}),ie=t(()=>!1),re=t(()=>{if(!G.value)return null;try{const e=G.value.trim();if(e.startsWith("{")&&e.endsWith("}")){return JSON.parse(e)}const a=G.value.match(/```json\s*([\s\S]*?)\s*```/);if(a){return JSON.parse(a[1])}return null}catch(e){return null}});function ue(){const e=k.findTodayDailyFortune();if(e){const a=e.result.data;B.value=a,G.value=e.result.aiResponse||"",Q.value=!0,T.hasUsedToday()||T.markAsUsed()}else Q.value=!1}function de(){ce()}async function ce(e=!1){if(I.value)return;const a=k.findTodayDailyFortune();if(a&&!e){const e=a.result.data;return B.value=e,G.value=a.result.aiResponse||"",Q.value=!0,void(T.hasUsedToday()||T.markAsUsed())}if(a&&e){const e=a.result.data;B.value=e,Q.value=!0,b.value=!0,I.value=!1,G.value="";try{await S.startDivination({type:"daily",question:"请为我分析今日运势",supplementaryInfo:{}},{onInitialResult:()=>{b.value=!0},onAIChunk:e=>{G.value+=e},onAIComplete:e=>{G.value=e.aiResponse||"",b.value=!1,I.value=!1,a.result.aiResponse=e.aiResponse||"",k.updateRecord(a.id,a)},onAIError:e=>{b.value=!1,I.value=!1,X.value=e},onConversationUpdate:()=>{}})}catch(t){b.value=!1,I.value=!1,alert("运势解读失败，请稍后重试")}return}I.value=!0,b.value=!1,Q.value=!1,G.value="";try{await S.startDivination({type:"daily",question:"请为我分析今日运势",supplementaryInfo:{}},{onInitialResult:e=>{B.value=e.data,b.value=!0},onAIChunk:e=>{G.value+=e},onAIComplete:e=>{G.value=e.aiResponse||"",b.value=!1,I.value=!1,T.markAsUsed()},onAIError:e=>{b.value=!1,I.value=!1,X.value=e},onConversationUpdate:()=>{}})}catch(t){b.value=!1,I.value=!1,alert("抽取运势失败，请稍后重试")}}async function ve(){if(confirm("确定要删除今日运势吗？此操作将清除所有相关数据，不可撤销。"))try{const e=k.findTodayDailyFortune();e&&await k.deleteRecord(e.id);["daily_fortune_limit","sydf-history","daily-fortune-cache","today-fortune-result","fortune-cache-"+(new Date).toISOString().split("T")[0]].forEach(e=>{localStorage.removeItem(e)});for(let a=0;a<localStorage.length;a++){const e=localStorage.key(a);e&&(e.includes("fortune")||e.includes("daily")||e.includes("cache"))&&localStorage.removeItem(e)}B.value=null,G.value="",Q.value=!1,I.value=!1,b.value=!1,T.resetRecord(),await new Promise(e=>setTimeout(e,50)),ue(),await new Promise(e=>setTimeout(e,100)),alert("今日运势已彻底删除，页面已重置")}catch(e){alert("删除失败，请稍后重试")}}function ye(){B.value=null,G.value="",Q.value=!1,I.value=!1,b.value=!1}function me(){se.value&&(se.value.abort(),te.value=!0,b.value=!1,ae.value=!1)}function pe(){X.value=null,te.value=!1,B.value?ce(!0):ce()}function ge(){if(!ee.value.trim()||ae.value||!B.value)return;ae.value=!0;const e=[...Z.value],a=ee.value.trim();ee.value="";const t={id:Date.now().toString(),data:B.value,aiResponse:G.value};S.sendFollowUp(t.id,e,a,{onChunk:()=>{},onComplete:()=>{ae.value=!1},onError:e=>{X.value=e,ae.value=!1},onConversationUpdate:e=>{Z.value=e}})}return s(()=>{T.cleanupExpiredRecord(),ue()}),(e,a)=>(D(),l("div",C,[B.value||I.value?o("",!0):(D(),n(R,{key:0,title:"今日运势",description:"基于日家奇门遁甲算法，为您解析今日的整体运势，包含事业、财富、感情、健康等各方面的详细指导","button-text":"查看今日运势",loading:I.value,"loading-text":oe.value,"divination-type":"daily","show-inspiration":!1,onSubmit:de,onClear:ye},null,8,["loading","loading-text"])),B.value&&!i(w).query.historyId?(D(),l("div",A,[u("button",{class:"btn-secondary",onClick:ye},"← 返回")])):o("",!0),B.value?(D(),l("div",x,[a[2]||(a[2]=u("div",{class:"section-header"},[u("h2",{class:"section-title"},"今日运势")],-1)),b.value?(D(),l("div",F,[...a[1]||(a[1]=[u("div",{class:"ai-loading-content"},[u("div",{class:"ai-loading-spinner"}),u("span",null,"AI大师正在解读运势...")],-1)])])):o("",!0),u("div",_,[d(U,{"fortune-data":B.value,"ai-response":G.value,"show-lucky":!0,"detailed-analysis":re.value},null,8,["fortune-data","ai-response","detailed-analysis"])]),ie.value?(D(),l("div",j,[u("button",{class:"btn-danger",onClick:ve}," 🗑️ 删除今日运势 ")])):o("",!0)])):o("",!0),B.value&&(Z.value.length>0||ae.value)?(D(),l("div",M,[u("div",E,[a[5]||(a[5]=u("h3",{class:"section-title"},"AI对话",-1)),Z.value.length>0?(D(),l("div",N,[(D(!0),l(c,null,v(Z.value.filter(e=>"system"!==e.role),(e,t)=>(D(),l("div",{key:e.id||t,class:f(["chat-message",`message-${e.role}`])},["assistant"===e.role&&!e.content&&ae.value?(D(),l("div",$,[...a[3]||(a[3]=[u("span",null,null,-1),u("span",null,null,-1),u("span",null,null,-1)])])):(D(),l("div",q,y(e.content),1))],2))),128))])):o("",!0),X.value?(D(),l("div",Y,[u("div",O,[a[4]||(a[4]=u("div",{class:"error-line-1"},"哈哈，AI开小差咯",-1)),u("div",z,y(X.value),1),u("div",{class:"error-line-3"},[u("button",{class:"retry-button",onClick:pe},"重新生成解读")])])])):o("",!0)])])):o("",!0),B.value?(D(),l("div",H,[b.value?(D(),l("button",{key:0,class:"btn-secondary",onClick:me},"取消生成")):o("",!0),b.value||!X.value&&!te.value?o("",!0):(D(),l("button",{key:1,class:"btn-primary",onClick:pe}," 重新生成 "))])):o("",!0),B.value&&ne.value&&!b.value?(D(),l("div",J,[u("div",K,[m(u("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>ee.value=e),placeholder:"对今日运势进行追问...",disabled:ae.value,onKeydown:g(h(ge,["prevent"]),["enter"])},null,40,L),[[p,ee.value]]),u("button",{disabled:ae.value,onClick:ge},[ae.value?(D(),l("span",W,"发送中...")):(D(),l("span",V,"发送"))],8,P)])])):o("",!0)]))}}),[["__scopeId","data-v-c642d88c"]]);export{B as default};
