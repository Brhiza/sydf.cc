import{i as e,r as a,s as n,x as l,d as o,p as i,o as t,c as s,m as u,g as r,u as v,J as d,b as p,t as c,j as y,v as m,I as f,w as g,e as h,K as b}from"./vendor.BUyyYNCK.js";import{D as w}from"./DivinationInput.Brsvyl9k.js";import{D as I}from"./DivinationResult.CSNdhZxr.js";import{d as R,h as k,p as C,g as T,e as q,E as U,_ as x}from"./index.B8UD4Q2h.js";import"./utils.CwRxlNlL.js";import"./markdown.CaxBdgEJ.js";import"./DailyResult.beaeZfvF.js";const A={key:1,class:"result-header-actions"},H={key:3,class:"ai-actions"},_={key:4,class:"content-card error-card"},j={class:"content-text"},D={key:5,class:"content-card follow-up-card"},S={class:"follow-up-input"},E=["disabled"],L=["disabled"],F={key:0},N={key:1},V=x(o({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(o){const x=o,V=n(),O=e(()=>T(x.divinationType)),P=a(null),{question:J,isLoading:G,result:K,aiResponse:Q,error:W,isAiLoading:Y,hasResult:$,hasAiResponse:z,viewingHistory:B,isCancelled:M,startDivination:X,clearResult:Z,regenerateAI:ee,handleHistoryParam:ae,clearHistoryParam:ne,cancelGeneration:le,conversationHistory:oe,followUpQuestion:ie,isFollowUpLoading:te,handleSendFollowUp:se}=function(o){const i=n(),t=l(),s=e(()=>o.divinationType),u=a(""),r=a(!1),v=a(null),d=a(""),p=a(null),c=a(!1),y=a(!1),m=a(null),f=a(!1),g=a([]),h=a(""),b=a(!1),w=e(()=>null!==v.value),I=e(()=>""!==d.value);async function T(e={}){if(r.value||!u.value.trim())return;r.value=!0,c.value=!0,p.value=null,v.value=null,d.value="",f.value=!1,m.value=new AbortController,g.value=[];const{supplementaryInfo:a,...n}=e,l={type:s.value,question:u.value.trim(),...n,signal:m.value.signal};a&&(l.supplementaryInfo=a),C(l,{onInitialResult:e=>{v.value=e,r.value=!1},onAIChunk:e=>{d.value+=e},onAIComplete:e=>{c.value=!1,v.value&&(v.value.aiResponse=e.aiResponse||"")},onAIError:e=>{p.value=e,c.value=!1,r.value=!1},onConversationUpdate:e=>{g.value=e}})}function q(e){y.value=!0;const a=k.getRecord(e);a?(u.value=a.question,v.value=JSON.parse(JSON.stringify(a.result)),d.value=a.result.aiResponse||"",g.value=a.conversationHistory||[]):t.push(`/divination/${s.value}`)}return{question:u,isLoading:r,result:v,aiResponse:d,error:p,isAiLoading:c,viewingHistory:y,isCancelled:f,conversationHistory:g,followUpQuestion:h,isFollowUpLoading:b,hasResult:w,hasAiResponse:I,startDivination:T,clearResult:function(){v.value=null,d.value="",p.value=null,u.value="",y.value=!1,g.value=[],h.value=""},loadResultFromHistory:q,regenerateAI:async function(){u.value&&await T()},clearHistoryParam:function(){if(i.query.historyId){const e={...i.query};delete e.historyId,t.replace({path:i.path,query:e})}},cancelGeneration:function(){m.value&&(m.value.abort(),f.value=!0,c.value=!1,b.value=!1)},handleSendFollowUp:function(){if(!h.value.trim()||b.value||!v.value)return;b.value=!0;const e=[...g.value],a=h.value.trim();h.value="",R.sendFollowUp(v.value.id,e,a,{onChunk:()=>{},onComplete:()=>{b.value=!1},onError:e=>{p.value=e,b.value=!1},onConversationUpdate:e=>{g.value=e}})},handleHistoryParam:function(){const e=i.query.historyId;e&&q(e)}}}(x),ue=e(()=>K.value?{data:K.value.data,aiResponse:Q.value}:{data:{},aiResponse:""}),re=a("single");function ve(e){if(e.startsWith("tarot_")){const a=e.replace("tarot_","");re.value=a}}function de(e){e.question&&(J.value=e.question);const a={};"tarot"===x.divinationType?a.spreadType=re.value:"ssgw"===x.divinationType&&void 0!==e.signNumber&&(a.signNumber=e.signNumber),e.supplementaryInfo&&(a.supplementaryInfo=e.supplementaryInfo),X(a)}function pe(){Z(),ne()}function ce(){W.value=null}function ye(){ee()}return i(()=>x.divinationType,(e,a)=>{!B.value&&a&&e!==a&&(Z(),ne(),J.value="",ie.value="",oe.value=[],W.value=null,M.value=!1,async function(){await b(),P.value&&(P.value.scrollTop=0),window.scrollTo(0,0)}(),q.emit(U.HISTORY_SELECTION_RESET))},{immediate:!1}),i(O,()=>{}),i(()=>V.query.historyId,(e,a)=>{e&&"string"==typeof e?ae():a&&!e&&Z()},{immediate:!0}),t(()=>{ae()}),(e,a)=>(h(),s("div",{ref_key:"pageContainerRef",ref:P,key:o.divinationType,class:"page-container"},[v($)||v(G)?r("",!0):(h(),u(w,{key:0,modelValue:v(J),"onUpdate:modelValue":a[0]||(a[0]=e=>d(J)?J.value=e:null),title:O.value?.title||"",description:O.value?.description||"","button-text":O.value?.buttonText||"开始占卜",loading:v(G),placeholder:O.value?.placeholder||"",examples:O.value?.examples||[],"divination-type":o.divinationType,"hide-after-submit":!1,onSubmit:de,onTypeChange:ve,onClear:v(Z)},null,8,["modelValue","title","description","button-text","loading","placeholder","examples","divination-type","onClear"])),v($)&&!v(V).query.historyId?(h(),s("div",A,[p("button",{class:"btn-secondary",onClick:pe},"← 返回")])):r("",!0),v($)?(h(),u(I,{key:2,type:o.divinationType,result:ue.value,"is-ai-loading":v(Y)||v(te),error:v(W),question:v(J),"conversation-history":v(oe),"is-follow-up-loading":v(te),onRetry:ye},null,8,["type","result","is-ai-loading","error","question","conversation-history","is-follow-up-loading"])):r("",!0),v($)?(h(),s("div",H,[v(Y)?(h(),s("button",{key:0,class:"btn-secondary",onClick:a[1]||(a[1]=(...e)=>v(le)&&v(le)(...e))},"取消生成")):r("",!0),v(Y)||!v(W)&&!v(M)?r("",!0):(h(),s("button",{key:1,class:"btn-primary",onClick:ye}," 重新生成 "))])):r("",!0),v(W)&&!v($)?(h(),s("div",_,[p("p",j,c(v(W)),1),p("div",{class:"form-actions"},[p("button",{class:"btn-primary",onClick:ce},"重试")])])):r("",!0),v(z)&&!v(Y)?(h(),s("div",D,[p("div",S,[y(p("textarea",{"onUpdate:modelValue":a[2]||(a[2]=e=>d(ie)?ie.value=e:null),placeholder:"对AI的解读进行追问...",disabled:v(te),onKeydown:a[3]||(a[3]=f(g((...e)=>v(se)&&v(se)(...e),["prevent"]),["enter"]))},null,40,E),[[m,v(ie)]]),p("button",{disabled:v(te),onClick:a[4]||(a[4]=(...e)=>v(se)&&v(se)(...e))},[v(te)?(h(),s("span",N,"发送中...")):(h(),s("span",F,"发送"))],8,L)])])):r("",!0)]))}}),[["__scopeId","data-v-170807af"]]);export{V as default};
