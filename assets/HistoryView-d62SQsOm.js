import{D as e}from"./DivinationResult-DrU7cpwL.js";import{h as s,A as t,e as a,E as n,b as i,_ as o}from"./index-D7xoNd1D.js";import{r as l,s as c,d as r,m as d,o as u,a as p,c as y,u as v,b as f,t as h,p as m,f as R,F as g,k,e as I}from"./vendor-cAEEXcX9.js";import"./markdown-CaxBdgEJ.js";import"./utils-CwRxlNlL.js";const b={class:"page-container"},A={key:0,class:"content-card"},D={class:"detail-header"},w={class:"header-left"},H={class:"section-title"},S={class:"detail-date"},C={class:"header-actions"},E={class:"detail-content"},_={class:"detail-question"},x={class:"content-text"},j={class:"detail-result"},q={class:"form-actions"},N={key:1,class:"content-card"},O={class:"history-content"},$={key:0,class:"empty-message"},T={key:1,class:"history-list"},B=["onClick"],J={class:"item-header"},z={class:"item-type"},L={class:"item-date"},P={class:"item-question"},U={key:0,class:"form-actions"},Y=o(r({__name:"HistoryView",props:{selectedRecordId:{type:String,default:null},showDetail:{type:Boolean,default:!1}},setup(o){const r=o,{historyRecords:Y,selectedRecord:F,loadHistory:V,viewHistoryDetail:G,clearAllHistory:K,deleteHistoryRecord:M,goBack:Q}=function(e){const t=c(),a=l([]),n=l(null);function i(){t.push("/history")}return{historyRecords:a,selectedRecord:n,loadHistory:function(){if(a.value=s.getRecords(),e){const s=a.value.find(s=>s.id===e);s?n.value=s:t.push("/history")}},viewHistoryDetail:function(e){t.push(`/divination/${e.type}?historyId=${e.id}`)},clearAllHistory:function(){confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")&&(s.clearRecords(),a.value=[],n.value=null)},deleteHistoryRecord:function(e){confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")&&(s.deleteRecord(e),i())},goBack:i}}(r.selectedRecordId),{getAIError:W,handleRetryAI:X}=function(){const e=l(!1);return{isRetryingAI:e,getAIError:function(e){return e.result.aiResponse?["æŠ±æ­‰","æš‚æ—¶ä¸å¯ç”¨","è¯·ç¨åé‡è¯•","å‡ºå°å·®","è¯·æ±‚è¿‡äºé¢‘ç¹","æœåŠ¡å™¨æš‚æ—¶ç¹å¿™"].some(s=>e.result.aiResponse?.includes(s))?e.result.aiResponse:null:"AIè§£è¯»æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"},handleRetryAI:async function(a){if(!e.value){e.value=!0;try{const e=JSON.parse(JSON.stringify(a.result.data)),n=[{role:"system",content:"ä½ æ˜¯ç²¾é€šå‘¨æ˜“ã€æ¢…èŠ±æ˜“æ•°ã€å¥‡é—¨éç”²ã€å¡”ç½—ç‰Œç­‰æœ¯æ•°çš„AIåŠ©æ‰‹ã€‚è¯·æ ¹æ®å åœç»“æœï¼Œä¸ºç”¨æˆ·æä¾›è§£è¯»ã€‚"},{role:"user",content:`è¯·ä¸ºä»¥ä¸‹å åœç»“æœæä¾›è§£è¯»ï¼šç±»å‹-${a.type}ï¼Œé—®é¢˜-${a.question}ï¼Œæ•°æ®-${JSON.stringify(e)}`}],i=await t.generateResponse(n);if(!i?.content)throw new Error("AIæœåŠ¡è¿”å›ç©ºå“åº”");a.result.aiResponse=i.content,s.updateRecord(a.id,a)}catch(n){const e=n instanceof Error?n.message:"é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";a.result.aiResponse=e,s.updateRecord(a.id,a)}finally{e.value=!1}}}}}();function Z(e){return new Date(e).toLocaleDateString("zh-CN")}function ee(e){const s=i(e);return s?s.title:"æœªçŸ¥å åœ"}return d(()=>r.selectedRecordId,e=>{if(e){const s=Y.value.find(s=>s.id===e);s&&(F.value=s)}else F.value=null}),u(()=>{V(),a.on(n.HISTORY_UPDATED,V)}),p(()=>{a.off(n.HISTORY_UPDATED,V)}),(s,t)=>{return I(),y("div",b,[o.showDetail&&v(F)?(I(),y("div",A,[f("div",D,[f("div",w,[f("h2",H,h(ee(v(F).type)),1),f("p",S,h((a=v(F).timestamp,new Date(a).toLocaleString("zh-CN"))),1)]),f("div",C,[f("button",{class:"btn-secondary",onClick:t[0]||(t[0]=(...e)=>v(Q)&&v(Q)(...e))},[...t[4]||(t[4]=[f("span",{class:"back-icon"},"â†",-1),f("span",{class:"back-text"},"è¿”å›",-1)])])])]),f("div",E,[f("div",_,[t[5]||(t[5]=f("h3",{class:"section-subtitle"},"é—®é¢˜",-1)),f("p",x,h(v(F).question),1)]),f("div",j,[t[6]||(t[6]=f("h3",{class:"section-subtitle"},"ç»“æœ",-1)),m(e,{type:v(F).type,result:{...v(F).result,id:v(F).id},error:v(W)(v(F)),onRetry:t[1]||(t[1]=e=>v(X)(v(F)))},null,8,["type","result","error"])])]),f("div",q,[f("button",{class:"btn-danger",onClick:t[2]||(t[2]=e=>v(M)(v(F).id))},[...t[7]||(t[7]=[f("span",{class:"delete-icon"},"ğŸ—‘ï¸",-1),f("span",{class:"delete-text"},"åˆ é™¤è®°å½•",-1)])])])])):(I(),y("div",N,[t[9]||(t[9]=f("div",{class:"card-header"},[f("h2",{class:"page-title"},"å†å²è®°å½•"),f("p",{class:"content-text"},"è¿™é‡Œä¿å­˜äº†æ‚¨æœ€è¿‘çš„å åœè®°å½•ï¼Œä»…ä¿å­˜åœ¨æœ¬åœ°å“¦ã€‚")],-1)),f("div",O,[0===v(Y).length?(I(),y("div",$,[...t[8]||(t[8]=[f("div",{class:"empty-icon"},"ğŸ“œ",-1),f("p",null,"æš‚æ— å†å²è®°å½•",-1),f("p",{class:"empty-hint"},"æ‚¨çš„å åœè®°å½•å°†ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ",-1)])])):(I(),y("div",T,[(I(!0),y(g,null,k(v(Y),e=>(I(),y("div",{key:e.id,class:"history-item"},[f("button",{class:"history-item-button",onClick:s=>v(G)(e)},[f("div",J,[f("span",z,h(ee(e.type)),1),f("span",L,h(Z(e.timestamp)),1)]),f("div",P,h(e.question),1)],8,B)]))),128))]))]),v(Y).length>0?(I(),y("div",U,[f("button",{class:"btn-danger",onClick:t[3]||(t[3]=(...e)=>v(K)&&v(K)(...e))},"æ¸…ç©ºå†å²è®°å½•")])):R("",!0)]))]);var a}}}),[["__scopeId","data-v-36994e65"]]);export{Y as default};
