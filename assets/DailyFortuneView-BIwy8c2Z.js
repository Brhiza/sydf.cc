import{d as e,r as a,i as t,o as s,c as l,m as n,g as i,u as o,s as r,b as u,q as c,t as d,F as v,l as f,j as p,v as m,I as h,w as g,n as y,e as D}from"./vendor-BUyyYNCK.js";import{s as w,h as S,d as k,_ as b}from"./index-1KWhz6Xq.js";import{D as I}from"./DivinationInput-BI_bLe4h.js";import{D as U}from"./DailyResult-C0PuzRhT.js";import"./utils-CwRxlNlL.js";const T="daily_fortune_limit";class R{static hasUsedToday(){const e=new Date,a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),t=this.getRecord();return t.date===a&&t.hasUsed}static markAsUsed(){const e=new Date,a={date:e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),hasUsed:!0,timestamp:Date.now()};w.setItem(T,a)}static getRecord(){const e=w.getItem(T);return e||{date:"",hasUsed:!1,timestamp:0}}static canDrawToday(){return!this.hasUsedToday()}static getTimeUntilNextDraw(){if(this.canDrawToday())return{canDraw:!0,hoursRemaining:0,minutesRemaining:0,message:"现在可以抽取今日运势"};const e=new Date,a=new Date(e);a.setDate(a.getDate()+1),a.setHours(0,0,0,0);const t=a.getTime()-e.getTime(),s=Math.floor(t/36e5),l=Math.floor(t%36e5/6e4);let n="";return n=s>0?`距离下次可抽取还有 ${s} 小时${l>0?` ${l} 分钟`:""}`:`距离下次可抽取还有 ${l} 分钟`,{canDraw:!1,hoursRemaining:s,minutesRemaining:l,message:n}}static getTodayStatus(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),s=e.date===t&&e.hasUsed;let l,n;if(s&&(l=new Date(e.timestamp).toLocaleString("zh-CN")),!this.canDrawToday()){const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),n=e.toLocaleString("zh-CN")}const i={hasUsed:s,canDraw:this.canDrawToday()};return l&&(i.usedTime=l),n&&(i.nextAvailableTime=n),i}static resetRecord(){w.removeItem(T)}static cleanupExpiredRecord(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");e.date!==t&&w.removeItem(T)}static getUsageStats(){const e=this.getRecord(),a={totalDays:e.hasUsed?1:0,currentStreak:e.hasUsed?1:0};return e.hasUsed&&(a.lastUsedDate=e.date),a}}const C={class:"page-container"},j={key:1,class:"result-header-actions"},A={key:2,class:"content-card"},F={key:0,class:"ai-loading"},x={class:"fortune-result"},_={class:"result-header"},z={class:"info-line"},M={class:"info-value"},q={class:"info-line"},E={class:"info-value"},N={class:"info-line"},$={class:"info-value"},Y={class:"info-line"},O={class:"info-value"},H={class:"info-line"},J={class:"info-value"},K={class:"info-line"},L={class:"info-value"},P={class:"info-line"},V={class:"info-value"},W={class:"info-line"},B={class:"info-value"},G={class:"info-line"},Q={class:"info-value"},X={key:1,class:"result-actions"},Z={key:3,class:"content-card"},ee={class:"conversation-section"},ae={key:0,class:"conversation-history"},te={key:0,class:"loading-dots"},se={key:1,class:"message-content"},le={key:1,class:"error-state"},ne={class:"error-content"},ie={class:"error-line-2"},oe={key:4,class:"content-card follow-up-card"},re={class:"follow-up-input"},ue=["disabled","onKeydown"],ce=["disabled"],de={key:0},ve={key:1},fe=b(e({__name:"DailyFortuneView",setup(e){const w=r(),b=a(!1),T=a(!1),fe=a(null),pe=a(""),me=a(!1),he=a(null),ge=a([]),ye=a(""),De=a(!1),we=["正在解析天机，请稍候...","奇门遁甲排盘中...","AI大师正在为您解读运势...","正在分析今日吉凶...","正在计算幸运元素..."],Se=t(()=>""!==pe.value),ke=t(()=>{const e=Math.floor(Math.random()*we.length);return we[e]}),be=t(()=>!1),Ie=t(()=>{if(!pe.value)return null;try{const e=pe.value.trim();if(e.startsWith("{")&&e.endsWith("}")){return JSON.parse(e)}const a=pe.value.match(/```json\s*([\s\S]*?)\s*```/);if(a){return JSON.parse(a[1])}return null}catch(e){return null}});function Ue(){const e=S.findTodayDailyFortune();if(e){const a=e.result.data;fe.value=a,pe.value=e.result.aiResponse||"",me.value=!0,R.hasUsedToday()||R.markAsUsed()}else me.value=!1}function Te(){Re()}async function Re(){if(b.value)return;const e=S.findTodayDailyFortune();if(e){const a=e.result.data;return fe.value=a,pe.value=e.result.aiResponse||"",me.value=!0,void(R.hasUsedToday()||R.markAsUsed())}b.value=!0,T.value=!1,me.value=!1,pe.value="";try{await k.startDivination({type:"daily",question:"请为我分析今日运势",supplementaryInfo:{}},{onInitialResult:e=>{fe.value=e.data,T.value=!0},onAIChunk:e=>{pe.value+=e},onAIComplete:e=>{pe.value=e.aiResponse||"",T.value=!1,b.value=!1,R.markAsUsed()},onAIError:()=>{T.value=!1,b.value=!1,alert("运势解读失败，请稍后重试")},onConversationUpdate:()=>{}})}catch(a){T.value=!1,b.value=!1,alert("抽取运势失败，请稍后重试")}}async function Ce(){if(confirm("确定要删除今日运势吗？此操作将清除所有相关数据，不可撤销。"))try{const e=S.findTodayDailyFortune();e&&await S.deleteRecord(e.id);["daily_fortune_limit","sydf-history","daily-fortune-cache","today-fortune-result","fortune-cache-"+(new Date).toISOString().split("T")[0]].forEach(e=>{localStorage.removeItem(e)});for(let a=0;a<localStorage.length;a++){const e=localStorage.key(a);e&&(e.includes("fortune")||e.includes("daily")||e.includes("cache"))&&localStorage.removeItem(e)}fe.value=null,pe.value="",me.value=!1,b.value=!1,T.value=!1,R.resetRecord(),await new Promise(e=>setTimeout(e,50)),Ue(),await new Promise(e=>setTimeout(e,100)),alert("今日运势已彻底删除，页面已重置")}catch(e){alert("删除失败，请稍后重试")}}function je(){fe.value=null,pe.value="",me.value=!1,b.value=!1,T.value=!1}function Ae(){fe.value&&Re()}function Fe(){if(!ye.value.trim()||De.value||!fe.value)return;De.value=!0;const e=[...ge.value],a=ye.value.trim();ye.value="";const t={id:Date.now().toString(),data:fe.value,aiResponse:pe.value};k.sendFollowUp(t.id,e,a,{onChunk:()=>{},onComplete:()=>{De.value=!1},onError:e=>{he.value=e,De.value=!1},onConversationUpdate:e=>{ge.value=e}})}return s(()=>{R.cleanupExpiredRecord(),Ue()}),(e,a)=>(D(),l("div",C,[fe.value||b.value?i("",!0):(D(),n(I,{key:0,title:"今日运势（测试）",description:"基于日家奇门遁甲算法，为您解析今日的整体运势，包含事业、财富、感情、健康等各方面的详细指导","button-text":"查看今日运势",loading:b.value,"loading-text":ke.value,"divination-type":"daily","show-inspiration":!1,onSubmit:Te,onClear:je},null,8,["loading","loading-text"])),fe.value&&!o(w).query.historyId?(D(),l("div",j,[u("button",{class:"btn-secondary",onClick:je},"← 返回")])):i("",!0),fe.value?(D(),l("div",A,[a[11]||(a[11]=u("div",{class:"section-header"},[u("h2",{class:"section-title"},"今日运势")],-1)),T.value?(D(),l("div",F,[...a[1]||(a[1]=[u("div",{class:"ai-loading-content"},[u("div",{class:"ai-loading-spinner"}),u("span",null,"AI大师正在解读运势...")],-1)])])):i("",!0),u("div",x,[u("div",_,[u("div",z,[a[2]||(a[2]=u("span",{class:"info-label"},"公历时间：",-1)),u("span",M,d(fe.value.date),1)]),u("div",q,[a[3]||(a[3]=u("span",{class:"info-label"},"干支：",-1)),u("span",E,d(fe.value.ganzhi?.year)+"年 "+d(fe.value.ganzhi?.month)+"月 "+d(fe.value.ganzhi?.day)+"日 "+d(fe.value.ganzhi?.hour)+"时",1)]),u("div",N,[a[4]||(a[4]=u("span",{class:"info-label"},"奇门局数：",-1)),u("span",$,d(fe.value.qimen?.timeInfo?.dunType)+d(fe.value.qimen?.timeInfo?.juShu)+"局",1)]),u("div",Y,[a[5]||(a[5]=u("span",{class:"info-label"},"值符值使：",-1)),u("span",O,d(fe.value.qimen?.timeInfo?.zhiFu)+"配"+d(fe.value.qimen?.timeInfo?.zhiShi),1)]),u("div",H,[a[6]||(a[6]=u("span",{class:"info-label"},"整体运势：",-1)),u("span",J,d(fe.value.overall?.luck)+"（"+d(fe.value.overall?.score)+"分）",1)]),u("div",K,[a[7]||(a[7]=u("span",{class:"info-label"},"幸运数字：",-1)),u("span",L,d(fe.value.lucky?.numbers?.join("、")||"暂无"),1)]),u("div",P,[a[8]||(a[8]=u("span",{class:"info-label"},"幸运颜色：",-1)),u("span",V,d(fe.value.lucky?.colors?.join("、")||"暂无"),1)]),u("div",W,[a[9]||(a[9]=u("span",{class:"info-label"},"幸运方向：",-1)),u("span",B,d(fe.value.lucky?.directions?.join("、")||"暂无"),1)]),u("div",G,[a[10]||(a[10]=u("span",{class:"info-label"},"幸运时辰：",-1)),u("span",Q,d(fe.value.lucky?.time||"暂无"),1)])]),c(U,{"fortune-data":fe.value,"ai-response":pe.value,"show-lucky":!1,"detailed-analysis":Ie.value},null,8,["fortune-data","ai-response","detailed-analysis"])]),be.value?(D(),l("div",X,[u("button",{class:"btn-danger",onClick:Ce}," 🗑️ 删除今日运势 ")])):i("",!0)])):i("",!0),fe.value&&(ge.value.length>0||De.value)?(D(),l("div",Z,[u("div",ee,[a[14]||(a[14]=u("h3",{class:"section-title"},"AI对话",-1)),ge.value.length>0?(D(),l("div",ae,[(D(!0),l(v,null,f(ge.value.filter(e=>"system"!==e.role),(e,t)=>(D(),l("div",{key:e.id||t,class:y(["chat-message",`message-${e.role}`])},["assistant"===e.role&&!e.content&&De.value?(D(),l("div",te,[...a[12]||(a[12]=[u("span",null,null,-1),u("span",null,null,-1),u("span",null,null,-1)])])):(D(),l("div",se,d(e.content),1))],2))),128))])):i("",!0),he.value?(D(),l("div",le,[u("div",ne,[a[13]||(a[13]=u("div",{class:"error-line-1"},"哈哈，AI开小差咯",-1)),u("div",ie,d(he.value),1),u("div",{class:"error-line-3"},[u("button",{class:"retry-button",onClick:Ae},"重新生成解读")])])])):i("",!0)])])):i("",!0),fe.value&&Se.value&&!T.value?(D(),l("div",oe,[u("div",re,[p(u("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>ye.value=e),placeholder:"对今日运势进行追问...",disabled:De.value,onKeydown:h(g(Fe,["prevent"]),["enter"])},null,40,ue),[[m,ye.value]]),u("button",{disabled:De.value,onClick:Fe},[De.value?(D(),l("span",ve,"发送中...")):(D(),l("span",de,"发送"))],8,ce)])])):i("",!0)]))}}),[["__scopeId","data-v-3c0f35de"]]);export{fe as default};
