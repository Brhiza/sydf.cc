import{d as ee,S as j,f as v,g as M,h as K,i as Q,w as L,o as se,c as u,j as m,b as e,k as x,t as b,F as Y,r as J,l as g,m as ne,v as ae,n as le,p as ie,M as re,q as ue,s as H,x as X,E as Z,y as ce,e as l,_ as te,u as de,z as O,A as z,B as ve,D as pe,C as ge}from"./index-0-cv0d-P.js";import{g as fe}from"./divination-config-DPDDIOby.js";const ye={class:"content-card"},he={key:0,class:"shaking-process"},_e={class:"result-section"},me={key:0},Re={key:1,class:"tossing-process"},ke={class:"result-section"},we={key:0,class:"result-section"},be=["innerHTML"],Se={key:0},qe={key:1},Ie={key:1,class:"bei-container"},Te=["src","alt"],Ae={class:"button-wrapper"},De=["disabled"],$e={key:2,class:"final-result"},Ce={key:0,class:"debug-info"},Ee={key:1,class:"sign-container"},Me={class:"sign-header"},Ne={class:"sign-title"},Ve={class:"sign-content"},xe={class:"sign-story"},He={class:"story-content"},Be={class:"sign-details"},Le={class:"details-grid"},Ue={class:"detail-label"},Ge={class:"detail-value"},Pe={key:2,class:"ai-section"},Fe={class:"ai-card"},ze={class:"ai-input-section"},Oe=["disabled"],Qe={key:0},We={key:1,class:"loading-text"},je={key:3,class:"ai-response-section"},Ke={class:"ai-response"},Ye={key:4,class:"ai-error-section"},Je={class:"ai-error"},Xe={class:"error-content"},Ze={class:"error-line-2"},es=ee({__name:"SsgwResult",props:{question:{},loading:{type:Boolean,default:!1},error:{default:null}},setup(C){const R=C,A=Q(),y=j.length,r=v("result"),k=v("请静心默念，准备摇签..."),n=v(0),h=v(0),c=v(!1),D=v(!0),q=v([]),S=v(""),T=v(""),_=v(""),I=v(!1),w=v(null),$=v(""),t=M(()=>{if(n.value===0)return console.log("signData computed - currentQian is 0"),null;const o=K(n.value);return console.log("signData computed - 签号:",n.value,"签文:",o),o}),f=M(()=>!(A.query.historyId||_.value||w.value));function U(){r.value="shaking",k.value="正在摇签中...",setTimeout(()=>{n.value=Math.floor(Math.random()*j.length)+1,r.value="tossing",h.value=0,D.value=!1},2e3)}function G(){if(c.value)return;c.value=!0,q.value=[],S.value="";const o=ue();setTimeout(()=>{q.value=[o.bei1,o.bei2];const s=o.result;s==="圣杯"&&(D.value=!0),s==="圣杯"?(S.value="<strong>圣杯</strong> (一平一凸) - 神明同意此签。",setTimeout(()=>{S.value+="<p>正在为您解读签文...</p>",setTimeout(()=>{r.value="result",N()},2e3)},1e3)):(h.value++,s==="笑杯"?S.value="<strong>笑杯</strong> (两平) - 神明笑而不语，可能问题不明或时机未到。":S.value="<strong>阴杯</strong> (两凸) - 神明不同意此签。",h.value>=3?(S.value+="<p>您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。</p>",c.value=!1):(S.value+="<p>请重新为您摇签...</p>",setTimeout(()=>{U()},2e3))),c.value=!1},1300)}function N(){if(t.value)try{const o=R.question==="心中所想之事"?"三山国王灵签":R.question,s=H.addRecord({type:"ssgw",question:o,result:{type:"ssgw",data:{sign:{id:n.value,title:t.value.title,qianwen:t.value.qianwen,story:t.value.story,details:t.value.details}},aiResponse:_.value||void 0}});$.value=s.id,X.emit(Z.HISTORY_UPDATED,s),console.log("三山国王灵签历史记录已保存")}catch(o){console.error("保存历史记录失败:",o)}}async function B(){if(I.value||!t.value)return;I.value=!0,w.value=null;const o=T.value.trim()||"请结合我最初的问题，为我详细解读这支签。",s=`
您是一位精通中国传统文化和解签的AI大师。请根据以下信息，为用户提供详细、富有同理心和启发性的解答。

用户最初的问题是："${R.question}"
用户抽到了【三山国王灵签】第 ${n.value} 签：${t.value.title}
签文是："${t.value.qianwen}"
典故是："${t.value.story}"
详细解签包括：${Object.entries(t.value.details).map(([p,d])=>`${p}：${d}`).join("；")}

现在，用户追问了一个问题："${o}"

请遵循以下指引进行回答：
1. **结合问题**：将你的回答与用户最初的问题和追问的问题紧密结合。
2. **深入解读**：不要仅仅重复签文的字面意思，要深入挖掘其背后的象征意义和智慧。
3. **提供建议**：在分析的基础上，提供具体、积极、可行的行动建议。
4. **温暖鼓励**：用温暖、鼓励和富有同理心的语气进行回答，给予用户支持和力量。
5. **格式清晰**：使用分段和重点标识，让回答易于阅读。
  `;try{const d=await ce().generateResponse(s);_.value=d.content||"抱歉，AI解读暂时不可用。",a()}catch(p){console.error("AI解读失败:",p),w.value=p instanceof Error?p.message:"AI解读暂时不可用，请稍后再试。"}finally{I.value=!1}}function P(){w.value=null,B()}function a(){if(!(!$.value||!_.value))try{const o=H.getRecord($.value);if(o){o.result.aiResponse=_.value;const s=H.getRecords();localStorage.setItem("sydf-history",JSON.stringify(s)),X.emit(Z.HISTORY_UPDATED,o),console.log("历史记录AI解读已更新:",$.value)}}catch(o){console.error("更新历史记录AI解读失败:",o)}}function i(o){var s,p;try{const d=H.getRecord(o);if(d&&d.type==="ssgw"&&((p=(s=d.result)==null?void 0:s.data)!=null&&p.sign)){const F=d.result.data.sign;return n.value=F.id,r.value="result",d.result.aiResponse?["抱歉","暂时不可用","请稍后重试","出小差","请求过于频繁","服务器暂时繁忙"].some(oe=>{var W;return(W=d.result.aiResponse)==null?void 0:W.includes(oe)})?(w.value=d.result.aiResponse,_.value=""):(_.value=d.result.aiResponse,w.value=null):(w.value="AI解读暂时不可用，请稍后重试",_.value=""),console.log("从历史记录加载三山国王灵签:",F.id,F.title),!0}}catch(d){console.error("加载历史记录失败:",d)}return!1}function E(){const o=A.query.historyId;o&&i(o)||V()}function V(){const o=window.ssgwQianNumber;console.log("SsgwResult - 接收到的签号:",o),o&&o>0?(n.value=o,r.value="result",delete window.ssgwQianNumber,N()):(n.value=Math.floor(Math.random()*61)+1,r.value="result",N()),console.log("SsgwResult - 设置的签号:",n.value),console.log("SsgwResult - 签文数据:",K(n.value))}return L(()=>A.query.historyId,(o,s)=>{console.log("SsgwResult - 历史记录ID变化:",s,"->",o),o!==s&&(_.value="",T.value="",w.value=null,$.value="",E())},{immediate:!1}),se(()=>{E()}),(o,s)=>(l(),u("div",ye,[r.value==="shaking"?(l(),u("div",he,[e("div",_e,[o.question!=="心中所想之事"?(l(),u("p",me,[s[1]||(s[1]=x("您的问题是：")),e("strong",null,b(o.question),1)])):m("",!0),e("p",null,b(k.value),1)])])):m("",!0),r.value==="tossing"?(l(),u("div",Re,[e("div",ke,[e("p",null,[s[2]||(s[2]=x("求得第 ")),e("strong",null,b(n.value),1),s[3]||(s[3]=x(" 签。"))]),s[4]||(s[4]=e("p",null,"请投掷圣杯，询问三山国王是否同意此签...",-1))]),S.value?(l(),u("div",we,[e("p",{innerHTML:S.value},null,8,be),h.value>=3&&!D.value?(l(),u("p",Se,"您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。")):D.value?m("",!0):(l(),u("p",qe,"请重新为您摇签..."))])):m("",!0),q.value.length>0?(l(),u("div",Ie,[(l(!0),u(Y,null,J(q.value,(p,d)=>(l(),u("img",{key:d,src:`/static/${p}.png`,alt:p,class:"bei-image"},null,8,Te))),128))])):m("",!0),e("div",Ae,[e("button",{onClick:G,disabled:c.value,class:"toss-button"},b(c.value?"投掷中...":"投掷圣杯"),9,De)])])):m("",!0),r.value==="result"?(l(),u("div",$e,[t.value?m("",!0):(l(),u("div",Ce,[s[5]||(s[5]=e("p",null,"调试信息：",-1)),e("p",null,"当前签号："+b(n.value),1),e("p",null,"签文数据："+b(t.value),1),e("p",null,"SSGW_SIGNS长度："+b(g(y)),1)])),t.value?(l(),u("div",Ee,[e("div",Me,[e("h3",Ne,b(t.value.title),1),e("div",Ve,[e("p",null,[s[6]||(s[6]=e("strong",null,"签文：",-1)),x(b(t.value.qianwen),1)])])]),e("div",xe,[s[7]||(s[7]=e("h4",{class:"section-title"},"典故",-1)),e("p",He,b(t.value.story),1)]),e("div",Be,[s[8]||(s[8]=e("h4",{class:"section-title"},"详细解签",-1)),e("div",Le,[(l(!0),u(Y,null,J(t.value.details,(p,d)=>(l(),u("div",{key:d,class:"detail-item"},[e("span",Ue,b(d)+"：",1),e("span",Ge,b(p),1)]))),128))])])])):m("",!0),f.value?(l(),u("div",Pe,[e("div",Fe,[s[10]||(s[10]=e("div",{class:"ai-header"},[e("h2",{class:"ai-card-title"},"三山国王"),e("p",{class:"ai-card-description"},"三山国王是中国传统的占卜方式，通过卦象阴阳变化来预测事物的发展趋势")],-1)),e("div",ze,[ne(e("input",{"onUpdate:modelValue":s[0]||(s[0]=p=>T.value=p),type:"text",placeholder:"请输入您想要占卜的问题",class:"ai-input"},null,512),[[ae,T.value]]),e("button",{onClick:B,disabled:I.value,class:le(["ask-ai-button",{"ai-thinking":I.value}])},[I.value?(l(),u("span",We,s[9]||(s[9]=[x(" 思考中 "),e("span",{class:"loading-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1)]))):(l(),u("span",Qe,"询问赛博大师"))],10,Oe)])])])):m("",!0),_.value?(l(),u("div",je,[e("div",Ke,[ie(re,{content:_.value},null,8,["content"])])])):m("",!0),w.value?(l(),u("div",Ye,[e("div",Je,[e("div",Xe,[s[11]||(s[11]=e("div",{class:"error-line-1"},"哈哈，AI开小差咯",-1)),e("div",Ze,b(w.value),1),e("div",{class:"error-line-3"},[e("button",{onClick:P,class:"retry-button"}," 重新生成解读 ")])])])])):m("",!0)])):m("",!0)]))}}),ss=te(es,[["__scopeId","data-v-667c7650"]]);function ts(C){const R=Q(),A=de(),y=v(""),r=v(!1),k=v(null),n=v(""),h=v(null),c=v(!1),D=M(()=>k.value!==null),q=M(()=>n.value!=="");async function S(){if(!(r.value||!y.value.trim())){r.value=!0,c.value=!0,h.value=null,k.value=null,n.value="";try{const t=await O({type:C,question:y.value.trim()},f=>{n.value=f},f=>{h.value=f,c.value=!1});k.value={type:t.type,data:t.data,aiResponse:""},r.value=!1,t.aiResponse&&(n.value=t.aiResponse)}catch(t){console.error("占卜失败:",t),h.value=t instanceof Error?t.message:"占卜失败，请稍后重试",r.value=!1}finally{c.value=!1}}}function T(){k.value=null,n.value="",h.value=null,y.value=""}function _(t){const f=H.getRecord(t);f?(console.log("加载历史记录:",f),y.value=f.question,k.value=f.result,n.value=f.result.aiResponse||""):(console.error("未找到历史记录:",t),A.push(`/divination/${C}`))}async function I(){if(!(!k.value||c.value)){c.value=!0,h.value=null;try{const t=await O({type:C,question:y.value},f=>{n.value=f},f=>{h.value=f,c.value=!1});n.value=t.aiResponse||"",k.value&&(k.value.aiResponse=t.aiResponse)}catch(t){console.error("重新生成AI解读失败:",t),h.value="重新生成失败，请稍后重试"}finally{c.value=!1}}}function w(){const t=R.query.historyId;t&&_(t)}function $(){if(R.query.historyId){const t={...R.query};delete t.historyId,A.replace({path:R.path,query:t})}}return{question:y,isLoading:r,result:k,aiResponse:n,error:h,isAiLoading:c,hasResult:D,hasAiResponse:q,startDivination:S,clearResult:T,loadFromHistory:_,regenerateAI:I,handleHistoryParam:w,clearHistoryParam:$}}const os={class:"page-container"},ns={key:1,class:"back-button-container"},as={key:4,class:"content-card error-card"},ls={class:"content-text"},is=ee({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(C){const R=C,A=Q(),y=M(()=>fe(R.divinationType)),{question:r,isLoading:k,result:n,aiResponse:h,error:c,isAiLoading:D,hasResult:q,startDivination:S,clearResult:T,regenerateAI:_,handleHistoryParam:I,clearHistoryParam:w}=ts(R.divinationType),$=M(()=>n.value?{data:n.value.data,aiResponse:h.value}:{data:{},aiResponse:""}),t=v("single");function f(a){if(console.log("类型变化:",a),a.startsWith("tarot_")){const i=a.replace("tarot_","");t.value=i,console.log("牌阵类型更新为:",i)}}async function U(a){try{const i=await O({type:"tarot",question:a,spreadType:t.value},E=>{h.value=E});n.value=i}catch(i){console.error("塔罗牌占卜失败:",i),c.value=i instanceof Error?i.message:"塔罗牌占卜失败，请稍后重试"}}function G(a){const i=a||r.value;if(console.log("UnifiedDivinationView handleSubmit:",i),R.divinationType==="ssgw"){a&&(r.value=a),n.value={type:"ssgw",data:{qianNumber:window.ssgwQianNumber||Math.floor(Math.random()*100)+1},aiResponse:""};return}i&&i.trim()?(a&&(r.value=a),R.divinationType==="tarot"?U(i):S()):console.error("提交的问题为空")}function N(){T(),w()}function B(){c.value=null}function P(){_()}return L(()=>R.divinationType,(a,i)=>{i&&a!==i&&(console.log("占卜类型变化:",i,"->",a),console.log("新配置:",y.value),T(),w())}),L(y,a=>{console.log("配置更新:",a)}),L(()=>A.query.historyId,(a,i)=>{console.log("路由查询参数变化:",{oldId:i,newId:a}),a&&typeof a=="string"?(console.log("检测到历史记录参数:",a),I()):i&&!a&&(console.log("从历史记录模式切换到新建模式"),T())},{immediate:!0}),se(()=>{console.log("UnifiedDivinationView mounted, type:",R.divinationType),I()}),(a,i)=>{var E,V,o,s,p;return l(),u("div",os,[!g(q)&&!g(k)?(l(),z(pe,{key:0,title:((E=y.value)==null?void 0:E.title)||"",description:((V=y.value)==null?void 0:V.description)||"","button-text":((o=y.value)==null?void 0:o.buttonText)||"开始占卜",loading:g(k),placeholder:((s=y.value)==null?void 0:s.placeholder)||"",examples:((p=y.value)==null?void 0:p.examples)||[],"divination-type":a.divinationType,modelValue:g(r),"onUpdate:modelValue":i[0]||(i[0]=d=>ve(r)?r.value=d:null),onSubmit:G,onTypeChange:f,"hide-after-submit":!1},null,8,["title","description","button-text","loading","placeholder","examples","divination-type","modelValue"])):m("",!0),g(q)&&!g(A).query.historyId?(l(),u("div",ns,[e("button",{onClick:N,class:"btn-secondary"}," ← 返回 ")])):m("",!0),g(q)&&a.divinationType==="ssgw"?(l(),z(ss,{key:2,question:g(r),loading:g(D),error:g(c)},null,8,["question","loading","error"])):g(q)?(l(),z(ge,{key:3,type:a.divinationType,result:$.value,loading:g(D),error:g(c),question:g(r),onRetry:P},null,8,["type","result","loading","error","question"])):m("",!0),g(c)&&!g(q)?(l(),u("div",as,[e("p",ls,b(g(c)),1),e("div",{class:"form-actions"},[e("button",{onClick:B,class:"btn-primary"},"重试")])])):m("",!0)])}}}),vs=te(is,[["__scopeId","data-v-bfa29017"]]);export{vs as default};
