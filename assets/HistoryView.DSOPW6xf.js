import{D as e}from"./DivinationResult.Cjr3zS7q.js";import{h as t,A as s,e as a,E as i,g as n,_ as o}from"./index.CYWrnUEx.js";import{r as l,x as r,d as c,p as d,o as u,a as p,c as y,u as h,b as v,t as m,q as f,g,F as R,l as k,e as D}from"./vendor.BUyyYNCK.js";import"./markdown.CaxBdgEJ.js";import"./DailyResult.3MzE67gD.js";import"./utils.CwRxlNlL.js";const I={class:"page-container"},b={key:0,class:"content-card"},A={class:"detail-header"},w={class:"header-left"},H={class:"section-title"},S={class:"detail-date"},C={class:"header-actions"},j={class:"detail-content"},x={class:"detail-question"},E={class:"content-text"},_={class:"detail-result"},q={class:"form-actions"},N={key:1,class:"content-card"},$={class:"history-content"},O={key:0,class:"empty-message"},T={key:1,class:"history-list"},z=["onClick"],B={class:"item-header"},J={class:"item-type"},L={class:"item-date"},P={class:"item-question"},U={key:0,class:"form-actions"},Y=o(c({__name:"HistoryView",props:{selectedRecordId:{type:String,default:null},showDetail:{type:Boolean,default:!1}},setup(o){const c=o,{historyRecords:Y,selectedRecord:F,loadHistory:V,viewHistoryDetail:G,clearAllHistory:K,deleteHistoryRecord:M,goBack:Q}=function(e){const s=r(),a=l([]),i=l(null);function n(){s.push("/history")}return{historyRecords:a,selectedRecord:i,loadHistory:function(){if(a.value=t.getRecords(),e){const t=a.value.find(t=>t.id===e);t?i.value=t:s.push("/history")}},viewHistoryDetail:function(e){s.push(`/divination/${e.type}?historyId=${e.id}`)},clearAllHistory:function(){confirm("确定要清空所有历史记录吗？此操作不可撤销。")&&(t.clearRecords(),a.value=[],i.value=null)},deleteHistoryRecord:function(e){confirm("确定要删除这条记录吗？此操作不可撤销。")&&(t.deleteRecord(e),n())},goBack:n}}(c.selectedRecordId),{getAIError:W,handleRetryAI:X}=function(){const e=l(!1);return{isRetryingAI:e,getAIError:function(e){return e.result.aiResponse?["抱歉","暂时不可用","请稍后重试","出小差","请求过于频繁","服务器暂时繁忙"].some(t=>e.result.aiResponse?.includes(t))?e.result.aiResponse:null:"AI解读暂时不可用，请稍后重试"},handleRetryAI:async function(a){if(!e.value){e.value=!0;try{const e=JSON.parse(JSON.stringify(a.result.data)),i=(new Date).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),n=[{role:"system",content:"你是精通周易、梅花易数、奇门遁甲、塔罗牌等术数的AI助手。请根据占卜结果，为用户提供解读。"},{role:"user",content:`请为以下占卜结果提供解读：类型-${a.type}，问题-${a.question}，数据-${JSON.stringify(e)}\n\n当前时间：${i}`}],o=await s.generateResponse(n);if(!o?.content)throw new Error("AI服务返回空响应");a.result.aiResponse=o.content,t.updateRecord(a.id,a)}catch(i){const e=i instanceof Error?i.message:"重新生成失败，请稍后重试";a.result.aiResponse=e,t.updateRecord(a.id,a)}finally{e.value=!1}}}}}();function Z(e){return new Date(e).toLocaleDateString("zh-CN")}function ee(e){const t=n(e);return t?t.title:"未知占卜"}return d(()=>c.selectedRecordId,e=>{if(e){const t=Y.value.find(t=>t.id===e);t&&(F.value=t)}else F.value=null}),u(()=>{V(),a.on(i.HISTORY_UPDATED,V)}),p(()=>{a.off(i.HISTORY_UPDATED,V)}),(t,s)=>{return D(),y("div",I,[o.showDetail&&h(F)?(D(),y("div",b,[v("div",A,[v("div",w,[v("h2",H,m(ee(h(F).type)),1),v("p",S,m((a=h(F).timestamp,new Date(a).toLocaleString("zh-CN"))),1)]),v("div",C,[v("button",{class:"btn-secondary",onClick:s[0]||(s[0]=(...e)=>h(Q)&&h(Q)(...e))},[...s[4]||(s[4]=[v("span",{class:"back-icon"},"←",-1),v("span",{class:"back-text"},"返回",-1)])])])]),v("div",j,[v("div",x,[s[5]||(s[5]=v("h3",{class:"section-subtitle"},"问题",-1)),v("p",E,m(h(F).question),1)]),v("div",_,[s[6]||(s[6]=v("h3",{class:"section-subtitle"},"结果",-1)),f(e,{type:h(F).type,result:{...h(F).result,id:h(F).id},error:h(W)(h(F)),onRetry:s[1]||(s[1]=e=>h(X)(h(F)))},null,8,["type","result","error"])])]),v("div",q,[v("button",{class:"btn-danger",onClick:s[2]||(s[2]=e=>h(M)(h(F).id))},[...s[7]||(s[7]=[v("span",{class:"delete-icon"},"🗑️",-1),v("span",{class:"delete-text"},"删除记录",-1)])])])])):(D(),y("div",N,[s[9]||(s[9]=v("div",{class:"card-header"},[v("h2",{class:"page-title"},"历史记录"),v("p",{class:"content-text"},"这里保存了您最近的占卜记录，仅保存在本地哦。")],-1)),v("div",$,[0===h(Y).length?(D(),y("div",O,[...s[8]||(s[8]=[v("div",{class:"empty-icon"},"📜",-1),v("p",null,"暂无历史记录",-1),v("p",{class:"empty-hint"},"您的占卜记录将会显示在这里",-1)])])):(D(),y("div",T,[(D(!0),y(R,null,k(h(Y),e=>(D(),y("div",{key:e.id,class:"history-item"},[v("button",{class:"history-item-button",onClick:t=>h(G)(e)},[v("div",B,[v("span",J,m(ee(e.type)),1),v("span",L,m(Z(e.timestamp)),1)]),v("div",P,m(e.question),1)],8,z)]))),128))]))]),h(Y).length>0?(D(),y("div",U,[v("button",{class:"btn-danger",onClick:s[3]||(s[3]=(...e)=>h(K)&&h(K)(...e))},"清空历史记录")])):g("",!0)]))]);var a}}}),[["__scopeId","data-v-36994e65"]]);export{Y as default};
