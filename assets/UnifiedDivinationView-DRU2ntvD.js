import{d as Z,S as W,e as d,f as M,g as j,h as O,w as L,i as ee,c as u,j as m,a as e,k as H,t as S,F as K,r as Y,l as _,m as oe,v as ne,n as ae,p as le,M as ie,q as re,s as x,x as J,E as X,y as ue,o as l,_ as se,u as ce,z,A as ve,D as de,B as pe,C as ge}from"./index-CWlmWX8O.js";import{g as fe}from"./divination-config-DPDDIOby.js";const ye={class:"ssgw-result"},he={key:0,class:"shaking-process"},_e={class:"result-section"},me={key:0},Re={key:1,class:"tossing-process"},we={class:"result-section"},ke={key:0,class:"result-section"},Se=["innerHTML"],be={key:0},qe={key:1},Ie={key:1,class:"bei-container"},Te=["src","alt"],De={class:"button-wrapper"},Ae=["disabled"],$e={key:2,class:"final-result"},Ce={key:0,class:"debug-info"},Ee={key:1,class:"sign-container"},Me={class:"sign-header"},Ne={class:"sign-title"},Ve={class:"sign-content"},He={class:"sign-story"},xe={class:"story-content"},Be={class:"sign-details"},Le={class:"details-grid"},Ue={class:"detail-label"},Ge={class:"detail-value"},Pe={key:2,class:"ai-section"},Fe={class:"ai-card"},ze={class:"ai-input-section"},Oe=["disabled"],Qe={key:0},We={key:1,class:"loading-text"},je={key:3,class:"ai-response-section"},Ke={class:"ai-response"},Ye={key:4,class:"ai-error-section"},Je={class:"ai-error"},Xe={class:"error-content"},Ze={class:"error-line-2"},es=Z({__name:"SsgwResult",props:{question:{},loading:{type:Boolean,default:!1},error:{default:null}},setup(C){const R=C,D=O(),f=W.length,r=d("result"),w=d("请静心默念，准备摇签..."),n=d(0),y=d(0),c=d(!1),A=d(!0),I=d([]),b=d(""),T=d(""),h=d(""),q=d(!1),k=d(null),$=d(""),t=M(()=>{if(n.value===0)return console.log("signData computed - currentQian is 0"),null;const o=j(n.value);return console.log("signData computed - 签号:",n.value,"签文:",o),o}),g=M(()=>!(D.query.historyId||h.value||k.value));function U(){r.value="shaking",w.value="正在摇签中...",setTimeout(()=>{n.value=Math.floor(Math.random()*W.length)+1,r.value="tossing",y.value=0,A.value=!1},2e3)}function G(){if(c.value)return;c.value=!0,I.value=[],b.value="";const o=re();setTimeout(()=>{I.value=[o.bei1,o.bei2];const s=o.result;s==="圣杯"&&(A.value=!0),s==="圣杯"?(b.value="<strong>圣杯</strong> (一平一凸) - 神明同意此签。",setTimeout(()=>{b.value+="<p>正在为您解读签文...</p>",setTimeout(()=>{r.value="result",N()},2e3)},1e3)):(y.value++,s==="笑杯"?b.value="<strong>笑杯</strong> (两平) - 神明笑而不语，可能问题不明或时机未到。":b.value="<strong>阴杯</strong> (两凸) - 神明不同意此签。",y.value>=3?(b.value+="<p>您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。</p>",c.value=!1):(b.value+="<p>请重新为您摇签...</p>",setTimeout(()=>{U()},2e3))),c.value=!1},1300)}function N(){if(t.value)try{const o=R.question==="心中所想之事"?"三山国王灵签":R.question,s=x.addRecord({type:"ssgw",question:o,result:{type:"ssgw",data:{sign:{id:n.value,title:t.value.title,qianwen:t.value.qianwen,story:t.value.story,details:t.value.details}},aiResponse:h.value||void 0}});$.value=s.id,J.emit(X.HISTORY_UPDATED,s),console.log("三山国王灵签历史记录已保存")}catch(o){console.error("保存历史记录失败:",o)}}async function B(){if(q.value||!t.value)return;q.value=!0,k.value=null;const o=T.value.trim()||"请结合我最初的问题，为我详细解读这支签。",s=`
您是一位精通中国传统文化和解签的AI大师。请根据以下信息，为用户提供详细、富有同理心和启发性的解答。

用户最初的问题是："${R.question}"
用户抽到了【三山国王灵签】第 ${n.value} 签：${t.value.title}
签文是："${t.value.qianwen}"
典故是："${t.value.story}"
详细解签包括：${Object.entries(t.value.details).map(([p,v])=>`${p}：${v}`).join("；")}

现在，用户追问了一个问题："${o}"

请遵循以下指引进行回答：
1. **结合问题**：将你的回答与用户最初的问题和追问的问题紧密结合。
2. **深入解读**：不要仅仅重复签文的字面意思，要深入挖掘其背后的象征意义和智慧。
3. **提供建议**：在分析的基础上，提供具体、积极、可行的行动建议。
4. **温暖鼓励**：用温暖、鼓励和富有同理心的语气进行回答，给予用户支持和力量。
5. **格式清晰**：使用分段和重点标识，让回答易于阅读。
  `;try{const v=await ue().generateResponse(s);h.value=v.content||"抱歉，AI解读暂时不可用。",a()}catch(p){console.error("AI解读失败:",p),k.value=p instanceof Error?p.message:"AI解读暂时不可用，请稍后再试。"}finally{q.value=!1}}function P(){k.value=null,B()}function a(){if(!(!$.value||!h.value))try{const o=x.getRecord($.value);if(o){o.result.aiResponse=h.value;const s=x.getRecords();localStorage.setItem("sydf-history",JSON.stringify(s)),J.emit(X.HISTORY_UPDATED,o),console.log("历史记录AI解读已更新:",$.value)}}catch(o){console.error("更新历史记录AI解读失败:",o)}}function i(o){var s,p;try{const v=x.getRecord(o);if(v&&v.type==="ssgw"&&((p=(s=v.result)==null?void 0:s.data)!=null&&p.sign)){const F=v.result.data.sign;return n.value=F.id,r.value="result",v.result.aiResponse?["抱歉","暂时不可用","请稍后重试","出小差","请求过于频繁","服务器暂时繁忙"].some(te=>{var Q;return(Q=v.result.aiResponse)==null?void 0:Q.includes(te)})?(k.value=v.result.aiResponse,h.value=""):(h.value=v.result.aiResponse,k.value=null):(k.value="AI解读暂时不可用，请稍后重试",h.value=""),console.log("从历史记录加载三山国王灵签:",F.id,F.title),!0}}catch(v){console.error("加载历史记录失败:",v)}return!1}function E(){const o=D.query.historyId;o&&i(o)||V()}function V(){const o=window.ssgwQianNumber;console.log("SsgwResult - 接收到的签号:",o),o&&o>0?(n.value=o,r.value="result",delete window.ssgwQianNumber,N()):(n.value=Math.floor(Math.random()*61)+1,r.value="result",N()),console.log("SsgwResult - 设置的签号:",n.value),console.log("SsgwResult - 签文数据:",j(n.value))}return L(()=>D.query.historyId,(o,s)=>{console.log("SsgwResult - 历史记录ID变化:",s,"->",o),o!==s&&(h.value="",T.value="",k.value=null,$.value="",E())},{immediate:!1}),ee(()=>{E()}),(o,s)=>(l(),u("div",ye,[r.value==="shaking"?(l(),u("div",he,[e("div",_e,[o.question!=="心中所想之事"?(l(),u("p",me,[s[1]||(s[1]=H("您的问题是：")),e("strong",null,S(o.question),1)])):m("",!0),e("p",null,S(w.value),1)])])):m("",!0),r.value==="tossing"?(l(),u("div",Re,[e("div",we,[e("p",null,[s[2]||(s[2]=H("求得第 ")),e("strong",null,S(n.value),1),s[3]||(s[3]=H(" 签。"))]),s[4]||(s[4]=e("p",null,"请投掷圣杯，询问三山国王是否同意此签...",-1))]),b.value?(l(),u("div",ke,[e("p",{innerHTML:b.value},null,8,Se),y.value>=3&&!A.value?(l(),u("p",be,"您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。")):A.value?m("",!0):(l(),u("p",qe,"请重新为您摇签..."))])):m("",!0),I.value.length>0?(l(),u("div",Ie,[(l(!0),u(K,null,Y(I.value,(p,v)=>(l(),u("img",{key:v,src:`/static/${p}.png`,alt:p,class:"bei-image"},null,8,Te))),128))])):m("",!0),e("div",De,[e("button",{onClick:G,disabled:c.value,class:"toss-button"},S(c.value?"投掷中...":"投掷圣杯"),9,Ae)])])):m("",!0),r.value==="result"?(l(),u("div",$e,[t.value?m("",!0):(l(),u("div",Ce,[s[5]||(s[5]=e("p",null,"调试信息：",-1)),e("p",null,"当前签号："+S(n.value),1),e("p",null,"签文数据："+S(t.value),1),e("p",null,"SSGW_SIGNS长度："+S(_(f)),1)])),t.value?(l(),u("div",Ee,[e("div",Me,[e("h3",Ne,S(t.value.title),1),e("div",Ve,[e("p",null,[s[6]||(s[6]=e("strong",null,"签文：",-1)),H(S(t.value.qianwen),1)])])]),e("div",He,[s[7]||(s[7]=e("h4",{class:"section-title"},"典故",-1)),e("p",xe,S(t.value.story),1)]),e("div",Be,[s[8]||(s[8]=e("h4",{class:"section-title"},"详细解签",-1)),e("div",Le,[(l(!0),u(K,null,Y(t.value.details,(p,v)=>(l(),u("div",{key:v,class:"detail-item"},[e("span",Ue,S(v)+"：",1),e("span",Ge,S(p),1)]))),128))])])])):m("",!0),g.value?(l(),u("div",Pe,[e("div",Fe,[s[10]||(s[10]=e("div",{class:"ai-header"},[e("h2",{class:"ai-card-title"},"三山国王"),e("p",{class:"ai-card-description"},"三山国王是中国传统的占卜方式，通过卦象阴阳变化来预测事物的发展趋势")],-1)),e("div",ze,[oe(e("input",{"onUpdate:modelValue":s[0]||(s[0]=p=>T.value=p),type:"text",placeholder:"请输入您想要占卜的问题",class:"ai-input"},null,512),[[ne,T.value]]),e("button",{onClick:B,disabled:q.value,class:ae(["ask-ai-button",{"ai-thinking":q.value}])},[q.value?(l(),u("span",We,s[9]||(s[9]=[H(" 思考中 "),e("span",{class:"loading-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1)]))):(l(),u("span",Qe,"询问赛博大师"))],10,Oe)])])])):m("",!0),h.value?(l(),u("div",je,[e("div",Ke,[le(ie,{content:h.value},null,8,["content"])])])):m("",!0),k.value?(l(),u("div",Ye,[e("div",Je,[e("div",Xe,[s[11]||(s[11]=e("div",{class:"error-line-1"},"哈哈，AI开小差咯",-1)),e("div",Ze,S(k.value),1),e("div",{class:"error-line-3"},[e("button",{onClick:P,class:"retry-button"}," 重新生成解读 ")])])])])):m("",!0)])):m("",!0)]))}}),ss=se(es,[["__scopeId","data-v-c23d68c7"]]);function ts(C){const R=O(),D=ce(),f=d(""),r=d(!1),w=d(null),n=d(""),y=d(null),c=d(!1),A=M(()=>w.value!==null),I=M(()=>n.value!=="");async function b(){if(!(r.value||!f.value.trim())){r.value=!0,c.value=!0,y.value=null,w.value=null,n.value="";try{const t=await divinationService.performDivination({type:C,question:f.value.trim()},g=>{n.value=g},g=>{y.value=g,c.value=!1});w.value={type:t.type,data:t.data,aiResponse:""},r.value=!1,t.aiResponse&&(n.value=t.aiResponse)}catch(t){console.error("占卜失败:",t),y.value=t instanceof Error?t.message:"占卜失败，请稍后重试",r.value=!1}finally{c.value=!1}}}function T(){w.value=null,n.value="",y.value=null,f.value=""}function h(t){const g=x.getRecord(t);g?(console.log("加载历史记录:",g),f.value=g.question,w.value=g.result,n.value=g.result.aiResponse||""):(console.error("未找到历史记录:",t),D.push(`/divination/${C}`))}async function q(){if(!(!w.value||c.value)){c.value=!0,y.value=null;try{const t=await divinationService.performDivination({type:C,question:f.value},g=>{n.value=g},g=>{y.value=g,c.value=!1});n.value=t.aiResponse||"",w.value&&(w.value.aiResponse=t.aiResponse)}catch(t){console.error("重新生成AI解读失败:",t),y.value="重新生成失败，请稍后重试"}finally{c.value=!1}}}function k(){const t=R.query.historyId;t&&h(t)}function $(){if(R.query.historyId){const t={...R.query};delete t.historyId,D.replace({path:R.path,query:t})}}return{question:f,isLoading:r,result:w,aiResponse:n,error:y,isAiLoading:c,hasResult:A,hasAiResponse:I,startDivination:b,clearResult:T,loadFromHistory:h,regenerateAI:q,handleHistoryParam:k,clearHistoryParam:$}}const os={class:"unified-divination-view"},ns={class:"divination-container"},as={key:1},ls={key:2,class:"error-message"},is=Z({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(C){const R=C,D=O(),f=M(()=>fe(R.divinationType)),{question:r,isLoading:w,result:n,aiResponse:y,error:c,isAiLoading:A,hasResult:I,startDivination:b,clearResult:T,regenerateAI:h,handleHistoryParam:q,clearHistoryParam:k}=ts(R.divinationType),$=M(()=>n.value?{data:n.value.data,aiResponse:y.value}:{data:{},aiResponse:""}),t=d("single");function g(a){if(console.log("类型变化:",a),a.startsWith("tarot_")){const i=a.replace("tarot_","");t.value=i,console.log("牌阵类型更新为:",i)}}async function U(a){try{const i=await ge({type:"tarot",question:a,spreadType:t.value},E=>{y.value=E});n.value=i}catch(i){console.error("塔罗牌占卜失败:",i),c.value=i instanceof Error?i.message:"塔罗牌占卜失败，请稍后重试"}}function G(a){const i=a||r.value;if(console.log("UnifiedDivinationView handleSubmit:",i),R.divinationType==="ssgw"){a&&(r.value=a),n.value={type:"ssgw",data:{qianNumber:window.ssgwQianNumber||Math.floor(Math.random()*100)+1},aiResponse:""};return}i&&i.trim()?(a&&(r.value=a),R.divinationType==="tarot"?U(i):b()):console.error("提交的问题为空")}function N(){T(),k()}function B(){c.value=null}function P(){h()}return L(()=>R.divinationType,(a,i)=>{i&&a!==i&&(console.log("占卜类型变化:",i,"->",a),console.log("新配置:",f.value),T(),k())}),L(f,a=>{console.log("配置更新:",a)}),L(()=>D.query.historyId,(a,i)=>{console.log("路由查询参数变化:",{oldId:i,newId:a}),a&&typeof a=="string"?(console.log("检测到历史记录参数:",a),q()):i&&!a&&(console.log("从历史记录模式切换到新建模式"),T())},{immediate:!0}),ee(()=>{console.log("UnifiedDivinationView mounted, type:",R.divinationType),q()}),(a,i)=>{var E,V,o,s,p;return l(),u("div",os,[e("div",ns,[!_(I)&&!_(w)?(l(),z(de,{key:0,title:((E=f.value)==null?void 0:E.title)||"",description:((V=f.value)==null?void 0:V.description)||"","button-text":((o=f.value)==null?void 0:o.buttonText)||"开始占卜",loading:_(w),placeholder:((s=f.value)==null?void 0:s.placeholder)||"",examples:((p=f.value)==null?void 0:p.examples)||[],"divination-type":a.divinationType,modelValue:_(r),"onUpdate:modelValue":i[0]||(i[0]=v=>ve(r)?r.value=v:null),onSubmit:G,onTypeChange:g,"hide-after-submit":!1},null,8,["title","description","button-text","loading","placeholder","examples","divination-type","modelValue"])):m("",!0),_(I)?(l(),u("div",as,[_(D).query.historyId?m("",!0):(l(),u("button",{key:0,onClick:N,class:"back-button"}," ← 返回 ")),a.divinationType==="ssgw"?(l(),z(ss,{key:1,question:_(r),loading:_(A),error:_(c)},null,8,["question","loading","error"])):(l(),z(pe,{key:2,type:a.divinationType,result:$.value,loading:_(A),error:_(c),question:_(r),onRetry:P},null,8,["type","result","loading","error","question"]))])):m("",!0),_(c)&&!_(I)?(l(),u("div",ls,[e("p",null,S(_(c)),1),e("button",{onClick:B,class:"retry-button"},"重试")])):m("",!0)])])}}}),ds=se(is,[["__scopeId","data-v-b78af805"]]);export{ds as default};
