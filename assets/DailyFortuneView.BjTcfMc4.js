import{d as e,r as a,i as t,o as s,c as l,m as n,g as i,u as o,s as r,b as u,q as c,t as d,F as v,l as g,j as p,v as m,I as h,w as y,n as f,e as D}from"./vendor.BUyyYNCK.js";import{s as w,h as S,d as k,_ as b}from"./index.De43H881.js";import{D as U}from"./DivinationInput.BahGay7V.js";import{D as I}from"./DailyResult.C29O1e-I.js";import"./utils.CwRxlNlL.js";const R="daily_fortune_limit";class T{static hasUsedToday(){const e=new Date,a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),t=this.getRecord();return t.date===a&&t.hasUsed}static markAsUsed(){const e=new Date,a={date:e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),hasUsed:!0,timestamp:Date.now()};w.setItem(R,a)}static getRecord(){const e=w.getItem(R);return e||{date:"",hasUsed:!1,timestamp:0}}static canDrawToday(){return!this.hasUsedToday()}static getTimeUntilNextDraw(){if(this.canDrawToday())return{canDraw:!0,hoursRemaining:0,minutesRemaining:0,message:"ç°åœ¨å¯ä»¥æŠ½å–ä»Šæ—¥è¿åŠ¿"};const e=new Date,a=new Date(e);a.setDate(a.getDate()+1),a.setHours(0,0,0,0);const t=a.getTime()-e.getTime(),s=Math.floor(t/36e5),l=Math.floor(t%36e5/6e4);let n="";return n=s>0?`è·ç¦»ä¸‹æ¬¡å¯æŠ½å–è¿˜æœ‰ ${s} å°æ—¶${l>0?` ${l} åˆ†é’Ÿ`:""}`:`è·ç¦»ä¸‹æ¬¡å¯æŠ½å–è¿˜æœ‰ ${l} åˆ†é’Ÿ`,{canDraw:!1,hoursRemaining:s,minutesRemaining:l,message:n}}static getTodayStatus(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),s=e.date===t&&e.hasUsed;let l,n;if(s&&(l=new Date(e.timestamp).toLocaleString("zh-CN")),!this.canDrawToday()){const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),n=e.toLocaleString("zh-CN")}const i={hasUsed:s,canDraw:this.canDrawToday()};return l&&(i.usedTime=l),n&&(i.nextAvailableTime=n),i}static resetRecord(){w.removeItem(R)}static cleanupExpiredRecord(){const e=this.getRecord(),a=new Date,t=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");e.date!==t&&w.removeItem(R)}static getUsageStats(){const e=this.getRecord(),a={totalDays:e.hasUsed?1:0,currentStreak:e.hasUsed?1:0};return e.hasUsed&&(a.lastUsedDate=e.date),a}}const C={class:"page-container"},A={key:1,class:"result-header-actions"},j={key:2,class:"content-card"},x={key:0,class:"ai-loading"},F={class:"fortune-result"},_={class:"result-header"},M={class:"info-line"},z={class:"info-value"},E={class:"info-line"},N={class:"info-value"},$={class:"info-line"},Y={class:"info-value"},q={class:"info-line"},O={class:"info-value"},H={class:"info-line"},J={class:"info-value"},K={class:"info-line"},L={class:"info-value"},P={key:1,class:"result-actions"},V={key:3,class:"content-card"},W={class:"conversation-section"},B={key:0,class:"conversation-history"},G={key:0,class:"loading-dots"},Q={key:1,class:"message-content"},X={key:1,class:"error-state"},Z={class:"error-content"},ee={class:"error-line-2"},ae={key:4,class:"content-card follow-up-card"},te={class:"follow-up-input"},se=["disabled","onKeydown"],le=["disabled"],ne={key:0},ie={key:1},oe=b(e({__name:"DailyFortuneView",setup(e){const w=r(),b=a(!1),R=a(!1),oe=a(null),re=a(""),ue=a(!1),ce=a(null),de=a([]),ve=a(""),ge=a(!1),pe=["æ­£åœ¨è§£æå¤©æœºï¼Œè¯·ç¨å€™...","å¥‡é—¨éç”²æ’ç›˜ä¸­...","AIå¤§å¸ˆæ­£åœ¨ä¸ºæ‚¨è§£è¯»è¿åŠ¿...","æ­£åœ¨åˆ†æä»Šæ—¥å‰å‡¶...","æ­£åœ¨è®¡ç®—å¹¸è¿å…ƒç´ ..."],me=t(()=>""!==re.value),he=t(()=>{const e=Math.floor(Math.random()*pe.length);return pe[e]}),ye=t(()=>!1),fe=t(()=>{if(!re.value)return null;try{const e=re.value.trim();if(e.startsWith("{")&&e.endsWith("}")){return JSON.parse(e)}const a=re.value.match(/```json\s*([\s\S]*?)\s*```/);if(a){return JSON.parse(a[1])}return null}catch(e){return null}});function De(){const e=S.findTodayDailyFortune();if(e){const a=e.result.data;oe.value=a,re.value=e.result.aiResponse||"",ue.value=!0,T.hasUsedToday()||T.markAsUsed()}else ue.value=!1}function we(){Se()}async function Se(){if(b.value)return;const e=S.findTodayDailyFortune();if(e){const a=e.result.data;return oe.value=a,re.value=e.result.aiResponse||"",ue.value=!0,void(T.hasUsedToday()||T.markAsUsed())}b.value=!0,R.value=!1,ue.value=!1,re.value="";try{await k.startDivination({type:"daily",question:"è¯·ä¸ºæˆ‘åˆ†æä»Šæ—¥è¿åŠ¿",supplementaryInfo:{}},{onInitialResult:e=>{oe.value=e.data,R.value=!0},onAIChunk:e=>{re.value+=e},onAIComplete:e=>{re.value=e.aiResponse||"",R.value=!1,b.value=!1,T.markAsUsed()},onAIError:()=>{R.value=!1,b.value=!1,alert("è¿åŠ¿è§£è¯»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")},onConversationUpdate:()=>{}})}catch(a){R.value=!1,b.value=!1,alert("æŠ½å–è¿åŠ¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}}async function ke(){if(confirm("ç¡®å®šè¦åˆ é™¤ä»Šæ—¥è¿åŠ¿å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œä¸å¯æ’¤é”€ã€‚"))try{const e=S.findTodayDailyFortune();e&&await S.deleteRecord(e.id);["daily_fortune_limit","sydf-history","daily-fortune-cache","today-fortune-result","fortune-cache-"+(new Date).toISOString().split("T")[0]].forEach(e=>{localStorage.removeItem(e)});for(let a=0;a<localStorage.length;a++){const e=localStorage.key(a);e&&(e.includes("fortune")||e.includes("daily")||e.includes("cache"))&&localStorage.removeItem(e)}oe.value=null,re.value="",ue.value=!1,b.value=!1,R.value=!1,T.resetRecord(),await new Promise(e=>setTimeout(e,50)),De(),await new Promise(e=>setTimeout(e,100)),alert("ä»Šæ—¥è¿åŠ¿å·²å½»åº•åˆ é™¤ï¼Œé¡µé¢å·²é‡ç½®")}catch(e){alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}}function be(){oe.value=null,re.value="",ue.value=!1,b.value=!1,R.value=!1}function Ue(){oe.value&&Se()}function Ie(){if(!ve.value.trim()||ge.value||!oe.value)return;ge.value=!0;const e=[...de.value],a=ve.value.trim();ve.value="";const t={id:Date.now().toString(),data:oe.value,aiResponse:re.value};k.sendFollowUp(t.id,e,a,{onChunk:()=>{},onComplete:()=>{ge.value=!1},onError:e=>{ce.value=e,ge.value=!1},onConversationUpdate:e=>{de.value=e}})}return s(()=>{T.cleanupExpiredRecord(),De()}),(e,a)=>(D(),l("div",C,[oe.value||b.value?i("",!0):(D(),n(U,{key:0,title:"ä»Šæ—¥è¿åŠ¿",description:"åŸºäºæ—¥å®¶å¥‡é—¨éç”²ç®—æ³•ï¼Œä¸ºæ‚¨è§£æä»Šæ—¥çš„æ•´ä½“è¿åŠ¿ï¼ŒåŒ…å«äº‹ä¸šã€è´¢å¯Œã€æ„Ÿæƒ…ã€å¥åº·ç­‰å„æ–¹é¢çš„è¯¦ç»†æŒ‡å¯¼","button-text":"æŸ¥çœ‹ä»Šæ—¥è¿åŠ¿",loading:b.value,"loading-text":he.value,"divination-type":"daily","show-inspiration":!1,onSubmit:we,onClear:be},null,8,["loading","loading-text"])),oe.value&&!o(w).query.historyId?(D(),l("div",A,[u("button",{class:"btn-secondary",onClick:be},"â† è¿”å›")])):i("",!0),oe.value?(D(),l("div",j,[a[8]||(a[8]=u("div",{class:"section-header"},[u("h2",{class:"section-title"},"ä»Šæ—¥è¿åŠ¿")],-1)),R.value?(D(),l("div",x,[...a[1]||(a[1]=[u("div",{class:"ai-loading-content"},[u("div",{class:"ai-loading-spinner"}),u("span",null,"AIå¤§å¸ˆæ­£åœ¨è§£è¯»è¿åŠ¿...")],-1)])])):i("",!0),u("div",F,[u("div",_,[u("div",M,[a[2]||(a[2]=u("span",{class:"info-label"},"å…¬å†æ—¶é—´ï¼š",-1)),u("span",z,d(oe.value.date),1)]),u("div",E,[a[3]||(a[3]=u("span",{class:"info-label"},"å¹²æ”¯ï¼š",-1)),u("span",N,d(oe.value.ganzhi?.year)+"å¹´ "+d(oe.value.ganzhi?.month)+"æœˆ "+d(oe.value.ganzhi?.day)+"æ—¥ "+d(oe.value.ganzhi?.hour)+"æ—¶",1)]),u("div",$,[a[4]||(a[4]=u("span",{class:"info-label"},"å¹¸è¿æ•°å­—ï¼š",-1)),u("span",Y,d(oe.value.lucky?.numbers?.join("ã€")||"æš‚æ— "),1)]),u("div",q,[a[5]||(a[5]=u("span",{class:"info-label"},"å¹¸è¿é¢œè‰²ï¼š",-1)),u("span",O,d(oe.value.lucky?.colors?.join("ã€")||"æš‚æ— "),1)]),u("div",H,[a[6]||(a[6]=u("span",{class:"info-label"},"å¹¸è¿æ–¹å‘ï¼š",-1)),u("span",J,d(oe.value.lucky?.directions?.join("ã€")||"æš‚æ— "),1)]),u("div",K,[a[7]||(a[7]=u("span",{class:"info-label"},"å¹¸è¿æ—¶è¾°ï¼š",-1)),u("span",L,d(oe.value.lucky?.time||"æš‚æ— "),1)])]),c(I,{"fortune-data":oe.value,"ai-response":re.value,"show-lucky":!1,"detailed-analysis":fe.value},null,8,["fortune-data","ai-response","detailed-analysis"])]),ye.value?(D(),l("div",P,[u("button",{class:"btn-danger",onClick:ke}," ğŸ—‘ï¸ åˆ é™¤ä»Šæ—¥è¿åŠ¿ ")])):i("",!0)])):i("",!0),oe.value&&(de.value.length>0||ge.value)?(D(),l("div",V,[u("div",W,[a[11]||(a[11]=u("h3",{class:"section-title"},"AIå¯¹è¯",-1)),de.value.length>0?(D(),l("div",B,[(D(!0),l(v,null,g(de.value.filter(e=>"system"!==e.role),(e,t)=>(D(),l("div",{key:e.id||t,class:f(["chat-message",`message-${e.role}`])},["assistant"===e.role&&!e.content&&ge.value?(D(),l("div",G,[...a[9]||(a[9]=[u("span",null,null,-1),u("span",null,null,-1),u("span",null,null,-1)])])):(D(),l("div",Q,d(e.content),1))],2))),128))])):i("",!0),ce.value?(D(),l("div",X,[u("div",Z,[a[10]||(a[10]=u("div",{class:"error-line-1"},"å“ˆå“ˆï¼ŒAIå¼€å°å·®å’¯",-1)),u("div",ee,d(ce.value),1),u("div",{class:"error-line-3"},[u("button",{class:"retry-button",onClick:Ue},"é‡æ–°ç”Ÿæˆè§£è¯»")])])])):i("",!0)])])):i("",!0),oe.value&&me.value&&!R.value?(D(),l("div",ae,[u("div",te,[p(u("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>ve.value=e),placeholder:"å¯¹ä»Šæ—¥è¿åŠ¿è¿›è¡Œè¿½é—®...",disabled:ge.value,onKeydown:h(y(Ie,["prevent"]),["enter"])},null,40,se),[[m,ve.value]]),u("button",{disabled:ge.value,onClick:Ie},[ge.value?(D(),l("span",ie,"å‘é€ä¸­...")):(D(),l("span",ne,"å‘é€"))],8,le)])])):i("",!0)]))}}),[["__scopeId","data-v-f479b245"]]);export{oe as default};
