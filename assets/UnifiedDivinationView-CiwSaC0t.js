import{d as Z,S as W,e as d,f as N,g as j,h as Q,w as L,i as ee,c as u,j as y,a as e,k as H,t as k,F as Y,r as J,l as f,m as te,v as oe,n as ne,p as ae,M as le,q as ie,s as x,x as K,E as X,y as re,o as l,_ as se,u as ue,z as O,A as z,B as ce,D as de,C as ve}from"./index-Cjz-H7a7.js";import{g as pe}from"./divination-config-DPDDIOby.js";const ge={class:"ssgw-result"},fe={key:0,class:"shaking-process"},ye={class:"result-section"},he={key:0},_e={key:1,class:"tossing-process"},me={class:"result-section"},Re={key:0,class:"result-section"},ke=["innerHTML"],we={key:0},be={key:1},Se={key:1,class:"bei-container"},qe=["src","alt"],Ie={class:"button-wrapper"},Te=["disabled"],Ae={key:2,class:"final-result"},De={key:0,class:"debug-info"},$e={key:1,class:"sign-container"},Ce={class:"sign-header"},Me={class:"sign-title"},Ne={class:"sign-content"},Ve={class:"sign-story"},Ee={class:"story-content"},He={class:"sign-details"},xe={class:"details-grid"},Be={class:"detail-label"},Le={class:"detail-value"},Ue={key:2,class:"ai-section"},Ge={class:"ai-card"},Pe={class:"ai-input-section"},Fe=["disabled"],ze={key:0},Oe={key:1,class:"loading-text"},Qe={key:3,class:"ai-response-section"},We={class:"ai-response"},je={key:4,class:"ai-error-section"},Ye={class:"ai-error"},Je={class:"error-message"},Ke=Z({__name:"SsgwResult",props:{question:{},loading:{type:Boolean,default:!1},error:{default:null}},setup(C){const h=C,A=Q(),g=W.length,r=d("result"),_=d("请静心默念，准备摇签..."),n=d(0),m=d(0),c=d(!1),D=d(!0),I=d([]),w=d(""),T=d(""),R=d(""),q=d(!1),S=d(null),$=d(""),t=N(()=>{if(n.value===0)return console.log("signData computed - currentQian is 0"),null;const o=j(n.value);return console.log("signData computed - 签号:",n.value,"签文:",o),o}),b=N(()=>!(A.query.historyId||R.value||S.value));function U(){r.value="shaking",_.value="正在摇签中...",setTimeout(()=>{n.value=Math.floor(Math.random()*W.length)+1,r.value="tossing",m.value=0,D.value=!1},2e3)}function G(){if(c.value)return;c.value=!0,I.value=[],w.value="";const o=ie();setTimeout(()=>{I.value=[o.bei1,o.bei2];const s=o.result;s==="圣杯"&&(D.value=!0),s==="圣杯"?(w.value="<strong>圣杯</strong> (一平一凸) - 神明同意此签。",setTimeout(()=>{w.value+="<p>正在为您解读签文...</p>",setTimeout(()=>{r.value="result",V()},2e3)},1e3)):(m.value++,s==="笑杯"?w.value="<strong>笑杯</strong> (两平) - 神明笑而不语，可能问题不明或时机未到。":w.value="<strong>阴杯</strong> (两凸) - 神明不同意此签。",m.value>=3?(w.value+="<p>您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。</p>",c.value=!1):(w.value+="<p>请重新为您摇签...</p>",setTimeout(()=>{U()},2e3))),c.value=!1},1300)}function V(){if(t.value)try{const o=h.question==="心中所想之事"?"三山国王灵签":h.question,s=x.addRecord({type:"ssgw",question:o,result:{type:"ssgw",data:{sign:{id:n.value,title:t.value.title,qianwen:t.value.qianwen,story:t.value.story,details:t.value.details}},aiResponse:R.value||void 0}});$.value=s.id,K.emit(X.HISTORY_UPDATED,s),console.log("三山国王灵签历史记录已保存")}catch(o){console.error("保存历史记录失败:",o)}}async function B(){if(q.value||!t.value)return;q.value=!0,S.value=null;const o=T.value.trim()||"请结合我最初的问题，为我详细解读这支签。",s=`
您是一位精通中国传统文化和解签的AI大师。请根据以下信息，为用户提供详细、富有同理心和启发性的解答。

用户最初的问题是："${h.question}"
用户抽到了【三山国王灵签】第 ${n.value} 签：${t.value.title}
签文是："${t.value.qianwen}"
典故是："${t.value.story}"
详细解签包括：${Object.entries(t.value.details).map(([v,p])=>`${v}：${p}`).join("；")}

现在，用户追问了一个问题："${o}"

请遵循以下指引进行回答：
1. **结合问题**：将你的回答与用户最初的问题和追问的问题紧密结合。
2. **深入解读**：不要仅仅重复签文的字面意思，要深入挖掘其背后的象征意义和智慧。
3. **提供建议**：在分析的基础上，提供具体、积极、可行的行动建议。
4. **温暖鼓励**：用温暖、鼓励和富有同理心的语气进行回答，给予用户支持和力量。
5. **格式清晰**：使用分段和重点标识，让回答易于阅读。
  `;try{const p=await re().generateResponse(s);R.value=p.content||"抱歉，AI解读暂时不可用。",a()}catch(v){console.error("AI解读失败:",v),S.value=v instanceof Error?v.message:"AI解读暂时不可用，请稍后再试。"}finally{q.value=!1}}function P(){S.value=null,B()}function a(){if(!(!$.value||!R.value))try{const o=x.getRecord($.value);if(o){o.result.aiResponse=R.value;const s=x.getRecords();localStorage.setItem("sydf-history",JSON.stringify(s)),K.emit(X.HISTORY_UPDATED,o),console.log("历史记录AI解读已更新:",$.value)}}catch(o){console.error("更新历史记录AI解读失败:",o)}}function i(o){var s,v;try{const p=x.getRecord(o);if(p&&p.type==="ssgw"&&((v=(s=p.result)==null?void 0:s.data)!=null&&v.sign)){const F=p.result.data.sign;return n.value=F.id,r.value="result",p.result.aiResponse&&(R.value=p.result.aiResponse),console.log("从历史记录加载三山国王灵签:",F.id,F.title),!0}}catch(p){console.error("加载历史记录失败:",p)}return!1}function M(){const o=A.query.historyId;o&&i(o)||E()}function E(){const o=window.ssgwQianNumber;console.log("SsgwResult - 接收到的签号:",o),o&&o>0?(n.value=o,r.value="result",delete window.ssgwQianNumber,V()):(n.value=Math.floor(Math.random()*61)+1,r.value="result",V()),console.log("SsgwResult - 设置的签号:",n.value),console.log("SsgwResult - 签文数据:",j(n.value))}return L(()=>A.query.historyId,(o,s)=>{console.log("SsgwResult - 历史记录ID变化:",s,"->",o),o!==s&&(R.value="",T.value="",S.value=null,$.value="",M())},{immediate:!1}),ee(()=>{M()}),(o,s)=>(l(),u("div",ge,[r.value==="shaking"?(l(),u("div",fe,[e("div",ye,[o.question!=="心中所想之事"?(l(),u("p",he,[s[1]||(s[1]=H("您的问题是：")),e("strong",null,k(o.question),1)])):y("",!0),e("p",null,k(_.value),1)])])):y("",!0),r.value==="tossing"?(l(),u("div",_e,[e("div",me,[e("p",null,[s[2]||(s[2]=H("求得第 ")),e("strong",null,k(n.value),1),s[3]||(s[3]=H(" 签。"))]),s[4]||(s[4]=e("p",null,"请投掷圣杯，询问三山国王是否同意此签...",-1))]),w.value?(l(),u("div",Re,[e("p",{innerHTML:w.value},null,8,ke),m.value>=3&&!D.value?(l(),u("p",we,"您已连续三次未能获得圣杯，看来今日不宜再问此事，请改日再来。")):D.value?y("",!0):(l(),u("p",be,"请重新为您摇签..."))])):y("",!0),I.value.length>0?(l(),u("div",Se,[(l(!0),u(Y,null,J(I.value,(v,p)=>(l(),u("img",{key:p,src:`/static/${v}.png`,alt:v,class:"bei-image"},null,8,qe))),128))])):y("",!0),e("div",Ie,[e("button",{onClick:G,disabled:c.value,class:"toss-button"},k(c.value?"投掷中...":"投掷圣杯"),9,Te)])])):y("",!0),r.value==="result"?(l(),u("div",Ae,[t.value?y("",!0):(l(),u("div",De,[s[5]||(s[5]=e("p",null,"调试信息：",-1)),e("p",null,"当前签号："+k(n.value),1),e("p",null,"签文数据："+k(t.value),1),e("p",null,"SSGW_SIGNS长度："+k(f(g)),1)])),t.value?(l(),u("div",$e,[e("div",Ce,[e("h3",Me,k(t.value.title),1),e("div",Ne,[e("p",null,[s[6]||(s[6]=e("strong",null,"签文：",-1)),H(k(t.value.qianwen),1)])])]),e("div",Ve,[s[7]||(s[7]=e("h4",{class:"section-title"},"典故",-1)),e("p",Ee,k(t.value.story),1)]),e("div",He,[s[8]||(s[8]=e("h4",{class:"section-title"},"详细解签",-1)),e("div",xe,[(l(!0),u(Y,null,J(t.value.details,(v,p)=>(l(),u("div",{key:p,class:"detail-item"},[e("span",Be,k(p)+"：",1),e("span",Le,k(v),1)]))),128))])])])):y("",!0),b.value?(l(),u("div",Ue,[e("div",Ge,[s[10]||(s[10]=e("div",{class:"ai-header"},[e("h2",{class:"ai-card-title"},"三山国王"),e("p",{class:"ai-card-description"},"三山国王是中国传统的占卜方式，通过卦象阴阳变化来预测事物的发展趋势")],-1)),e("div",Pe,[te(e("input",{"onUpdate:modelValue":s[0]||(s[0]=v=>T.value=v),type:"text",placeholder:"请输入您想要占卜的问题",class:"ai-input"},null,512),[[oe,T.value]]),e("button",{onClick:B,disabled:q.value,class:ne(["ask-ai-button",{"ai-thinking":q.value}])},[q.value?(l(),u("span",Oe,s[9]||(s[9]=[H(" 思考中 "),e("span",{class:"loading-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1)]))):(l(),u("span",ze,"询问赛博大师"))],10,Fe)])])])):y("",!0),R.value?(l(),u("div",Qe,[e("div",We,[ae(le,{content:R.value},null,8,["content"])])])):y("",!0),S.value?(l(),u("div",je,[e("div",Ye,[s[11]||(s[11]=e("div",{class:"error-icon"},"⚠️",-1)),s[12]||(s[12]=e("h3",{class:"error-title"},"AI解读失败",-1)),e("p",Je,k(S.value),1),e("div",{class:"error-actions"},[e("button",{onClick:P,class:"retry-button"}," 重新生成解读 ")])])])):y("",!0)])):y("",!0)]))}}),Xe=se(Ke,[["__scopeId","data-v-5bd122bd"]]);function Ze(C){const h=Q(),A=ue(),g=d(""),r=d(!1),_=d(null),n=d(""),m=d(null),c=d(!1),D=N(()=>_.value!==null),I=N(()=>n.value!=="");async function w(){if(!(r.value||!g.value.trim())){r.value=!0,c.value=!0,m.value=null,_.value=null,n.value="";try{const t=await O({type:C,question:g.value.trim()},b=>{n.value=b});_.value={type:t.type,data:t.data,aiResponse:""},r.value=!1,t.aiResponse&&(n.value=t.aiResponse)}catch(t){console.error("占卜失败:",t),m.value=t instanceof Error?t.message:"占卜失败，请稍后重试",r.value=!1}finally{c.value=!1}}}function T(){_.value=null,n.value="",m.value=null,g.value=""}function R(t){const b=x.getRecord(t);b?(console.log("加载历史记录:",b),g.value=b.question,_.value=b.result,n.value=b.result.aiResponse||""):(console.error("未找到历史记录:",t),A.push(`/divination/${C}`))}async function q(){if(!(!_.value||c.value)){c.value=!0,m.value=null;try{const t=await O({type:C,question:g.value},b=>{n.value=b});n.value=t.aiResponse||"",_.value&&(_.value.aiResponse=t.aiResponse)}catch(t){console.error("重新生成AI解读失败:",t),m.value="重新生成失败，请稍后重试"}finally{c.value=!1}}}function S(){const t=h.query.historyId;t&&R(t)}function $(){if(h.query.historyId){const t={...h.query};delete t.historyId,A.replace({path:h.path,query:t})}}return{question:g,isLoading:r,result:_,aiResponse:n,error:m,isAiLoading:c,hasResult:D,hasAiResponse:I,startDivination:w,clearResult:T,loadFromHistory:R,regenerateAI:q,handleHistoryParam:S,clearHistoryParam:$}}const es={class:"unified-divination-view"},ss={class:"divination-container"},ts={key:1},os={key:2,class:"error-message"},ns=Z({__name:"UnifiedDivinationView",props:{divinationType:{}},setup(C){const h=C,A=Q(),g=N(()=>pe(h.divinationType)),{question:r,isLoading:_,result:n,aiResponse:m,error:c,isAiLoading:D,hasResult:I,startDivination:w,clearResult:T,regenerateAI:R,handleHistoryParam:q,clearHistoryParam:S}=Ze(h.divinationType),$=N(()=>n.value?{data:n.value.data,aiResponse:m.value}:{data:{},aiResponse:""}),t=d("single");function b(a){if(console.log("类型变化:",a),a.startsWith("tarot_")){const i=a.replace("tarot_","");t.value=i,console.log("牌阵类型更新为:",i)}}async function U(a){try{const i=await O({type:"tarot",question:a,spreadType:t.value},M=>{m.value=M});n.value=i}catch(i){console.error("塔罗牌占卜失败:",i),c.value=i instanceof Error?i.message:"塔罗牌占卜失败，请稍后重试"}}function G(a){const i=a||r.value;if(console.log("UnifiedDivinationView handleSubmit:",i),h.divinationType==="ssgw"){a&&(r.value=a),n.value={type:"ssgw",data:{qianNumber:window.ssgwQianNumber||Math.floor(Math.random()*100)+1},aiResponse:""};return}i&&i.trim()?(a&&(r.value=a),h.divinationType==="tarot"?U(i):w()):console.error("提交的问题为空")}function V(){T(),S()}function B(){c.value=null}function P(){R()}return L(()=>h.divinationType,(a,i)=>{i&&a!==i&&(console.log("占卜类型变化:",i,"->",a),console.log("新配置:",g.value),T(),S())}),L(g,a=>{console.log("配置更新:",a)}),L(()=>A.query.historyId,(a,i)=>{console.log("路由查询参数变化:",{oldId:i,newId:a}),a&&typeof a=="string"?(console.log("检测到历史记录参数:",a),q()):i&&!a&&(console.log("从历史记录模式切换到新建模式"),T())},{immediate:!0}),ee(()=>{console.log("UnifiedDivinationView mounted, type:",h.divinationType),q()}),(a,i)=>{var M,E,o,s,v;return l(),u("div",es,[e("div",ss,[!f(I)&&!f(_)?(l(),z(de,{key:0,title:((M=g.value)==null?void 0:M.title)||"",description:((E=g.value)==null?void 0:E.description)||"","button-text":((o=g.value)==null?void 0:o.buttonText)||"开始占卜",loading:f(_),placeholder:((s=g.value)==null?void 0:s.placeholder)||"",examples:((v=g.value)==null?void 0:v.examples)||[],"divination-type":a.divinationType,modelValue:f(r),"onUpdate:modelValue":i[0]||(i[0]=p=>ce(r)?r.value=p:null),onSubmit:G,onTypeChange:b,"hide-after-submit":!1},null,8,["title","description","button-text","loading","placeholder","examples","divination-type","modelValue"])):y("",!0),f(I)?(l(),u("div",ts,[f(A).query.historyId?y("",!0):(l(),u("button",{key:0,onClick:V,class:"back-button"}," ← 返回 ")),a.divinationType==="ssgw"?(l(),z(Xe,{key:1,question:f(r),loading:f(D),error:f(c)},null,8,["question","loading","error"])):(l(),z(ve,{key:2,type:a.divinationType,result:$.value,loading:f(D),error:f(c),question:f(r),onRetry:P},null,8,["type","result","loading","error","question"]))])):y("",!0),f(c)&&!f(I)?(l(),u("div",os,[e("p",null,k(f(c)),1),e("button",{onClick:B,class:"retry-button"},"重试")])):y("",!0)])])}}}),is=se(ns,[["__scopeId","data-v-b78af805"]]);export{is as default};
