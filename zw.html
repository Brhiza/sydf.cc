<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紫薇斗数</title>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="static/favicon.png" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png">
    <link rel="stylesheet" href="css/paipan.css">
</head>
<body>
    <div class="container">
        <h1>紫微斗数排盘</h1>
        
        <div class="date-inputs-row">
            <div class="date-input-group">
                <label for="year">年</label>
                <input type="number" id="year" name="year" placeholder="2000" required>
            </div>
            <div class="date-input-group">
                <label for="month">月</label>
                <input type="number" id="month" name="month" min="1" max="12" placeholder="1-12" required>
            </div>
            <div class="date-input-group">
                <label for="day">日</label>
                <input type="number" id="day" name="day" min="1" max="31" placeholder="1-31" required>
            </div>
        </div>

        <div>
            <label for="hour">时辰:</label>
            <select id="hour" name="hour" required>
                <option value="0"selected>早子时 (00:00-01:00)</option>
                <option value="1">丑时 (01:00-03:00)</option>
                <option value="2">寅时 (03:00-05:00)</option>
                <option value="3">卯时 (05:00-07:00)</option>
                <option value="4">辰时 (07:00-09:00)</option>
                <option value="5">巳时 (09:00-11:00)</option>
                <option value="6">午时 (11:00-13:00)</option>
                <option value="7">未时 (13:00-15:00)</option>
                <option value="8">申时 (15:00-17:00)</option>
                <option value="9">酉时 (17:00-19:00)</option>
                <option value="10">戌时 (19:00-21:00)</option>
                <option value="11">亥时 (21:00-23:00)</option>
                <option value="12">晚子时 (23:00-24:00)</option>
            </select>
        </div>
        <div>
            <label>性别:</label>
            <div class="gender-buttons">
                <button type="button" class="gender-button" id="genderMale">男</button>
                <button type="button" class="gender-button" id="genderFemale">女</button>
            </div>
        </div>

        <div>
            <input type="checkbox" id="enableSecondPerson" onchange="toggleSecondPersonInputs()">
            <label for="enableSecondPerson" style="display: inline; margin-left: 5px;">合盘</label>
        </div>

        <div id="secondPersonInputs" style="display:none; margin-top: 20px; padding-top:20px; border-top: 1px dashed #ccc;">
            <h2>第二人信息</h2>
            <div class="date-inputs-row">
                <div class="date-input-group">
                    <label for="year2">年</label>
                    <input type="number" id="year2" name="year2" placeholder="2000">
                </div>
                <div class="date-input-group">
                    <label for="month2">月</label>
                    <input type="number" id="month2" name="month2" min="1" max="12" placeholder="1-12">
                </div>
                <div class="date-input-group">
                    <label for="day2">日</label>
                    <input type="number" id="day2" name="day2" min="1" max="31" placeholder="1-31">
                </div>
            </div>
            <div>
                <label for="hour2">时辰:</label>
                <select id="hour2" name="hour2">
                    <option value="0"selected>早子时 (00:00-01:00)</option>
                    <option value="1">丑时 (01:00-03:00)</option>
                    <option value="2">寅时 (03:00-05:00)</option>
                    <option value="3">卯时 (05:00-07:00)</option>
                    <option value="4">辰时 (07:00-09:00)</option>
                    <option value="5">巳时 (09:00-11:00)</option>
                    <option value="6">午时 (11:00-13:00)</option>
                    <option value="7">未时 (13:00-15:00)</option>
                    <option value="8">申时 (15:00-17:00)</option>
                    <option value="9">酉时 (17:00-19:00)</option>
                    <option value="10">戌时 (19:00-21:00)</option>
                    <option value="11">亥时 (21:00-23:00)</option>
                    <option value="12">晚子时 (23:00-24:00)</option>
                </select>
            </div>
            <div>
                <label>性别:</label>
                <div class="gender-buttons">
                    <button type="button" class="gender-button" id="genderMale2">男</button>
                    <button type="button" class="gender-button" id="genderFemale2">女</button>
                </div>
            </div>
        </div>

        <button class="ai-question-button" onclick="generateAstrolabe()">开始排盘</button>
        <h2>排盘结果:</h2>
        <div id="result" style="display:none;"></div>
        <div id="result2" style="margin-top: 20px; display:none;"></div>
        
        <!-- AI提问容器 -->
        <div id="aiQuestionContainer" style="display:none;">
            <div id="aiQuestionOptions">
                <button class="unified-button" data-default-text="请综合全面的分析我的排盘结果，1.星曜解读 - 主星：紫微、天机等14主星特性及庙旺落陷 - 辅星：文昌、文曲等吉星影响 - 煞星：擎羊、陀罗等煞星制化 - 四化：禄权科忌在各宫位的影响 
2.宫位分析 - 命宫：先天命格与性格特质 - 财帛宫：财富格局与赚钱方式 - 官禄宫：事业发展与职业倾向 - 夫妻宫：感情模式与婚姻状况 - 迁移宫：外出运与贵人运
3.大限流年推演 - 当前大限（10年运势）分析 - 今年流年运势详解 - 未来5年关键时间节点
4.补救建议 - 有利方位 - 适合职业 - 流年注意事项 - 风水调理建议
                    5.总结和建议以及注意事项。" onclick="selectOption(this, 'single')">综合</button>
                <button class="unified-button" data-default-text="请分析我在当前大运的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">大运</button>
                <button class="unified-button" data-default-text="请分析我在今年的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">流年</button>
                <button class="unified-button" data-default-text="请分析我今、明、后三年的运势，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">三年</button>
                <button class="unified-button" data-default-text="请分析我的事业和财运，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">事业财运</button>
                <button class="unified-button" data-default-text="请分析我的感情和婚姻状况，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">感情婚姻</button>
                <button class="unified-button" data-default-text="请分析我的健康状况，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'single')">健康</button>
                <button class="unified-button" onclick="showCustomInput('single'); selectOption(this, 'single');">自定义</button>
            </div>
            <div id="customQuestionContainer" style="width: 100%; margin-top: 10px;">
                <input type="text" id="customQuestion" placeholder="请输入您的问题" style="display: none; width: 100%; padding: 12px; border: 1px solid #c5cae9; border-radius: 6px; box-sizing: border-box; font-size: 16px;">
            </div>
            <button class="ai-question-button" onclick="askAI()" style="margin-top: 10px;">向 AI 提问</button>
        </div>

        <!-- 合盘分析容器 -->
        <div id="combinedAnalysisContainer" style="display:none;">
            <div id="combinedQuestionOptions">
                <button class="unified-button" data-default-text="请分析两个人命盘合不合，双方是否互补，双方性格怎么样，在一起几率高不高，有利和不利的婚姻因素，需要注意的年份，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'combined');">合婚</button>
                <button class="unified-button" data-default-text="请分析我们在事业合作方面的匹配度，并给出总结和建议以及注意事项。" onclick="selectOption(this, 'combined');">合作</button>
                <button class="unified-button" onclick="showCustomInput('combined'); selectOption(this, 'combined');">自定义</button>
            </div>
            <div id="customCombinedQuestionContainer" style="width: 100%; margin-top: 10px;">
                <input type="text" id="customCombinedQuestion" placeholder="请输入您的问题" style="display: none; width: 100%; padding: 12px; border: 1px solid #c5cae9; border-radius: 6px; box-sizing: border-box; font-size: 16px;">
            </div>
            <button class="ai-question-button" onclick="askAIForCompatibility()" style="margin-top: 10px;">AI 合盘分析</button>
        </div>

    </div>

    <script src="js/ai.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro@latest/dist/iztro.min.js"></script>
    <script src="js/paipan.js"></script>
    <script src="js/ui.js"></script>
    <script>
        function generateAstrolabeForPerson(personNumber, year, month, day, timeIndex, gender, resultDiv) {
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';

            if (isNaN(year) || isNaN(month) || isNaN(day) || timeIndex === null) {
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人：请输入所有必填的出生信息！</p>`;
                resultDiv.style.display = 'block';
                return null;
            }

            if (!gender) {
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人：性别都不告诉我？</p>`;
                resultDiv.style.display = 'block';
                return null;
            }

            const solarDate = `${year}-${month}-${day}`;

            try {
                const astrolabe = iztro.astro.bySolar(solarDate, timeIndex, gender, true, 'zh-CN');
                let htmlResult = `<h3>${personNumber === 1 ? '基本信息：' : `第${personNumber}人 - 基本信息：`}</h3>`;
                htmlResult += `<p><strong>阳历：</strong>${astrolabe.solarDate}</p>`;
                htmlResult += `<p><strong>农历：</strong>${astrolabe.lunarDate}</p>`;
                htmlResult += `<p><strong>干支：</strong>${astrolabe.chineseDate}</p>`;
                htmlResult += `<p><strong>性别：</strong>${astrolabe.gender}</p>`;
                htmlResult += `<p><strong>时辰：</strong>${astrolabe.time}</p>`;
                htmlResult += `<p><strong>命主：</strong>${astrolabe.soul}</p>`;
                htmlResult += `<p><strong>身主：</strong>${astrolabe.body}</p>`;
                htmlResult += `<p><strong>五行局：</strong>${astrolabe.fiveElementsClass}</p>`;
                htmlResult += `<p><strong>星座：</strong>${astrolabe.sign}</p>`;
                htmlResult += `<p><strong>生肖：</strong>${astrolabe.zodiac}</p>`;
                htmlResult += `<h3>${personNumber === 1 ? '宫位信息：' : `第${personNumber}人 - 宫位信息：`}</h3>`;
                htmlResult += '<ul>';
                astrolabe.palaces.forEach(palace => {
                    htmlResult += `<li><strong>${palace.name}宫 (${palace.heavenlyStem}${palace.earthlyBranch}):</strong>`;
                    htmlResult += ` 主星: ${palace.majorStars.map(s => s.name).join(', ') || '无'}`;
                    htmlResult += `; 副星: ${palace.minorStars.map(s => s.name).join(', ') || '无'}`;
                    htmlResult += `; 小星: ${palace.adjectiveStars.map(s => s.name).join(', ') || '无'}`;
                    htmlResult += `</li>`;
                });
                htmlResult += '</ul>';

                resultDiv.innerHTML = htmlResult;
                resultDiv.style.display = 'block';
                return astrolabe;
            } catch (error) {
                console.error(`第${personNumber}人排盘错误:`, error);
                resultDiv.innerHTML = `<p style="color: red;">第${personNumber}人排盘失败，请检查输入或查看控制台错误信息。</p><p>${error.message}</p>`;
                resultDiv.style.display = 'block';
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializePage({
                chartingFunction: generateAstrolabeForPerson,
                getAIPrompt: (questionText, selectedOption) => {
                    return `你是一个紫微斗数大师，现在是${new Date().toLocaleString()}，以下是排盘结果：\n${dom.result1Div.innerHTML}\n问题: ${questionText}\n请尽量详细的说明，需要注意1. 结构清晰
- 先总论命格特点
- 再分述各宫位运势
- 最后给出具体建议

2. 现代诠释
- 结合当代社会环境
- 给出可操作建议
- 避免宿命论表述

3. 验证体系
- 星曜印证度
- 宫位契合度
- 现实可解释性`;
                },
                getCompatibilityPrompt: (questionText) => {
                    return `你是一个紫微斗数大师，现在是${new Date().toLocaleString()}，以下是排盘结果：\n第一人排盘结果:\n${dom.result1Div.innerHTML}\n\n第二人排盘结果:\n${dom.result2Div.innerHTML}\n问题：${questionText}\n请尽量详细的说明`;
                }
            });
        });
    </script>
</body>
</html>
